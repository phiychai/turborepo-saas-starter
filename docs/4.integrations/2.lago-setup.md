---
title: 'Lago Setup & Configuration'
description: 'Complete guide to setting up and configuring Lago for billing and subscriptions'
navigation:
  title: 'Lago Setup'
  order: 3
---

This guide walks you through setting up Lago billing and subscription management in your SaaS application.

## Overview

**Lago** is an open-source billing platform that provides:
- ✅ Subscription management
- ✅ Usage-based billing
- ✅ Multi-gateway support (Stripe, PayPal, Adyen)
- ✅ Invoice generation
- ✅ Tax handling
- ✅ Real-time analytics

## Prerequisites

- Docker and Docker Compose installed
- PostgreSQL database running (included in docker-compose)
- Valid email for Lago admin account

## Quick Start

### 1. Environment Configuration

Copy and configure your environment variables:

```bash
# In root .env file
LAGO_API_PORT=3100
LAGO_FRONT_PORT=3001
LAGO_API_URL=http://localhost:3100
LAGO_FRONT_URL=http://localhost:3001

# Generate secure keys
LAGO_SECRET_KEY_BASE=$(openssl rand -hex 64)
LAGO_ENCRYPTION_PRIMARY_KEY=$(openssl rand -hex 32)
LAGO_ENCRYPTION_DETERMINISTIC_KEY=$(openssl rand -hex 32)
LAGO_ENCRYPTION_KEY_DERIVATION_SALT=$(openssl rand -hex 32)

# Optional: Generate RSA key for JWT
# LAGO_RSA_PRIVATE_KEY=$(openssl genrsa 2048 | base64 | tr -d '\n')

# Leave empty for now (will generate after setup)
LAGO_API_KEY=
```

### 2. Start Lago

```bash
# Start all services including Lago
docker compose up -d

# Check Lago logs
docker compose logs -f lago

# Wait for Lago to be ready (you should see):
# "Puma starting in single mode..."
# "Listening on http://0.0.0.0:3000"
```

### 3. Access Lago Frontend

1. Open your browser: `http://localhost:3001`
2. You should see the Lago setup wizard

### 4. Complete Setup Wizard

**Step 1: Create Organization**
- Organization name: Your company name
- Email: Your admin email
- Password: Choose a secure password

**Step 2: Configure Organization Settings**
- Currency: USD (or your preferred currency)
- Timezone: Your timezone
- Document locale: English

**Step 3: Generate API Key**
- Go to: Settings → API keys
- Click "Create API key"
- Copy the key (you'll need it for backend integration)
- Save it to your `.env` file as `LAGO_API_KEY`

## Backend Integration

### Update Environment Variables

Add the API key to both env files:

**Root `.env`:**
```bash
LAGO_API_KEY=your-generated-api-key-here
```

**`apps/backend/.env`:**
```bash
LAGO_API_URL=http://localhost:3100
LAGO_API_KEY=your-generated-api-key-here
```

### Restart Backend

```bash
# Restart to load new API key
docker compose restart backend

# Or if running locally
cd apps/backend
pnpm dev
```

## Creating Your First Plan

### Via Lago Frontend

1. Go to `http://localhost:3001`
2. Navigate to **Plans**
3. Click **Add a plan**
4. Fill in plan details:
   - **Code**: `starter_monthly` (used in API)
   - **Name**: Starter Plan
   - **Interval**: Monthly
   - **Amount**: 990 (in cents, = $9.90)
   - **Currency**: USD

5. Add charges (optional):
   - For usage-based billing
   - Example: API calls, storage, etc.

6. Click **Save**

### Via API (Programmatic)

```typescript
// Create a plan
const plan = await billingService.createPlan({
  code: 'pro_monthly',
  name: 'Professional Plan',
  interval: 'monthly',
  amount_cents: 2990,  // $29.90
  amount_currency: 'USD',
  description: 'Full access to all features'
});
```

## Creating Customers & Subscriptions

### Automatic Customer Creation

The billing service automatically creates Lago customers when users sign up:

```typescript
// apps/backend/app/controllers/billing_controller.ts
// This happens automatically on first billing request
async getOrCreateAccount({ auth, response }: HttpContext) {
  const user = auth.user!;

  // Creates customer in Lago if doesn't exist
  const account = await this.billingService.getOrCreateCustomer({
    externalId: user.id.toString(),
    name: user.fullName,
    email: user.email,
  });

  return response.ok({ account });
}
```

### Create Subscription

From your frontend:

```typescript
// In your Nuxt app
const { $fetch } = useNuxtApp();

// Subscribe user to a plan
const subscription = await $fetch('/api/billing/subscriptions', {
  method: 'POST',
  body: {
    planCode: 'starter_monthly',
    externalId: `sub_${Date.now()}`,
  }
});
```

## Webhook Configuration

### Set Up Webhooks

Lago sends webhooks for events (invoice paid, subscription ended, etc.)

1. **In Lago Frontend:**
   - Go to: Settings → Webhooks
   - Add endpoint URL: `https://your-domain.com/api/billing/webhooks`
   - Select events to receive

2. **In Backend (`apps/backend`):**

```typescript
// apps/backend/start/routes.ts
router.post('/api/billing/webhooks', async ({ request, response }) => {
  const payload = request.body();

  // Verify webhook signature (important!)
  // const signature = request.header('X-Lago-Signature');

  // Handle different event types
  switch (payload.event_type) {
    case 'invoice.paid':
      // Update user's subscription status
      break;
    case 'subscription.terminated':
      // Handle subscription cancellation
      break;
    // ... other events
  }

  return response.ok({ received: true });
});
```

## Payment Gateway Integration

### Stripe Setup

1. **Get Stripe Keys:**
   - Go to https://dashboard.stripe.com/apikeys
   - Copy your publishable and secret keys

2. **Configure in Lago:**
   - Frontend: Settings → Payment gateways
   - Select Stripe
   - Enter your secret key
   - Save

3. **Update Environment:**
```bash
STRIPE_API_KEY=sk_test_your_stripe_secret_key
STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key
```

4. **Connect Customer Payment Method:**
```typescript
// Link Stripe customer to Lago customer
await billingService.updateCustomer(userId, {
  billing_configuration: {
    payment_provider: 'stripe',
    provider_customer_id: stripeCustomerId
  }
});
```

## Testing the Integration

### 1. Check Lago is Running

```bash
# Health check
curl http://localhost:3100/health

# Should return: {"status":"ok"}
```

### 2. Test API Connection

```bash
# Get organization info (requires API key)
curl -X GET http://localhost:3100/api/v1/organizations \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json"
```

### 3. Test Customer Creation

```bash
# From your app
curl -X POST http://localhost:3333/api/billing/account \
  -H "Authorization: Bearer YOUR_AUTH_TOKEN" \
  -H "Content-Type: application/json"
```

### 4. Test Subscription Creation

```bash
curl -X POST http://localhost:3333/api/billing/subscriptions \
  -H "Authorization: Bearer YOUR_AUTH_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "planCode": "starter_monthly",
    "externalId": "sub_test_123"
  }'
```

## Common Issues & Solutions

### Issue 1: "Connection refused" Error

**Symptom:** Backend can't connect to Lago

**Solution:**
```bash
# Check if Lago is running
docker compose ps lago

# Check logs
docker compose logs lago

# Verify network
docker compose exec backend ping lago

# Restart Lago
docker compose restart lago
```

### Issue 2: "Unauthorized" API Errors

**Symptom:** 401 errors when calling Lago API

**Solution:**
```bash
# Verify API key is set
echo $LAGO_API_KEY

# Check it's in backend .env
cat apps/backend/.env | grep LAGO_API_KEY

# Restart backend after adding key
docker compose restart backend
```

### Issue 3: Database Migration Errors

**Symptom:** Lago won't start, database errors in logs

**Solution:**
```bash
# Reset Lago database
docker compose down
docker compose exec postgres psql -U postgres -c "DROP DATABASE lago_db;"
docker compose exec postgres psql -U postgres -c "CREATE DATABASE lago_db;"
docker compose up -d lago

# Lago will run migrations automatically
```

### Issue 4: Port Conflicts

**Symptom:** "Port already in use"

**Solution:**
```bash
# Check what's using the port
lsof -i :3100  # API port
lsof -i :3001  # Frontend port

# Change ports in .env
LAGO_API_PORT=3200
LAGO_FRONT_PORT=3201

# Update LAGO_API_URL too
LAGO_API_URL=http://localhost:3200
```

## Monitoring & Maintenance

### Check Lago Status

```bash
# Container status
docker compose ps lago

# Resource usage
docker stats lago

# Recent logs
docker compose logs --tail=100 lago
```

### Backup Lago Data

```bash
# Backup Lago database
docker compose exec postgres pg_dump -U postgres lago_db > lago_backup.sql

# Restore
cat lago_backup.sql | docker compose exec -T postgres psql -U postgres lago_db
```

### Update Lago

```bash
# Pull latest version
docker compose pull lago

# Restart with new version
docker compose up -d lago

# Check version
docker compose exec lago bundle exec rails runner "puts Rails.application.config.lago_version"
```

## Production Deployment

### Security Checklist

- [ ] Generate unique, secure keys (64+ characters)
- [ ] Use HTTPS for all endpoints
- [ ] Restrict API key access
- [ ] Enable webhook signature verification
- [ ] Set up proper firewall rules
- [ ] Use environment-specific API keys
- [ ] Enable audit logging
- [ ] Set up monitoring and alerts

### Production Environment Variables

```bash
# Use strong, unique keys
LAGO_SECRET_KEY_BASE=$(openssl rand -hex 128)
LAGO_ENCRYPTION_PRIMARY_KEY=$(openssl rand -hex 64)
LAGO_ENCRYPTION_DETERMINISTIC_KEY=$(openssl rand -hex 64)
LAGO_ENCRYPTION_KEY_DERIVATION_SALT=$(openssl rand -hex 64)

# Production URLs
LAGO_API_URL=https://billing-api.yourdomain.com
LAGO_FRONT_URL=https://billing.yourdomain.com

# Production database
POSTGRES_DB=lago_production
POSTGRES_USER=lago_user
POSTGRES_PASSWORD=strong_password_here

# Email configuration
LAGO_FROM_EMAIL=billing@yourdomain.com
LAGO_SMTP_ADDRESS=smtp.sendgrid.net
LAGO_SMTP_PORT=587
LAGO_SMTP_USERNAME=apikey
LAGO_SMTP_PASSWORD=your_sendgrid_api_key
```

## API Reference

### BillingService Methods

```typescript
// Customer management
await billingService.createCustomer(data)
await billingService.getCustomer(externalId)
await billingService.updateCustomer(externalId, data)

// Subscription management
await billingService.createSubscription(data)
await billingService.getSubscriptions(customerId)
await billingService.cancelSubscription(externalId)

// Invoice management
await billingService.getInvoices(customerId)
await billingService.downloadInvoice(invoiceId)

// Plan management
await billingService.getPlans()
await billingService.getPlan(code)
```

## Resources

- [Lago Documentation](https://docs.getlago.com/)
- [Lago API Reference](https://doc.getlago.com/api-reference/intro)
- [Lago GitHub](https://github.com/getlago/lago)
- [Lago Community Discord](https://discord.gg/lago)
- [Integration Guide](./LAGO_INTEGRATION.md)

## Next Steps

1. ✅ Complete Lago setup wizard
2. ✅ Generate API key
3. ✅ Create your first plan
4. ✅ Test customer/subscription creation
5. ✅ Set up payment gateway (Stripe)
6. ✅ Configure webhooks
7. ✅ Test end-to-end flow
8. ✅ Set up monitoring

