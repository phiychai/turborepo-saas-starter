# Lago Billing Integration

This document explains how Lago is integrated into the Turborepo SaaS Starter for subscription billing and payment management.

## What is Lago?

[Lago](https://www.getlago.com/) is an **open-source** billing platform designed for modern SaaS applications. It provides:

- ✅ **Subscription Management** (recurring billing, tiers, seats)
- ✅ **Usage-Based Billing** (metered billing, pay-as-you-go)
- ✅ **Multi-Gateway Support** (Stripe, PayPal, Adyen, etc.)
- ✅ **Invoice Generation** (PDF invoices with custom branding)
- ✅ **Tax Handling** (automated tax calculation)
- ✅ **Dunning Management** (failed payment retry logic)
- ✅ **REST API** (easy integration with any tech stack)
- ✅ **Admin Dashboard** (manage customers, plans, invoices)

## Architecture

```
┌──────────────┐
│  Nuxt (Web)  │
│  Port 3000   │
└──────┬───────┘
       │
       │ HTTP API
       │
┌──────▼────────────┐      ┌────────────────┐
│  AdonisJS Backend │─────▶│  Lago API      │──┬─▶ Stripe
│  Port 3333        │      │  Port 3100     │  │
│                   │◀─────│  (REST API)    │  ├─▶ PayPal
│  BillingService   │      │                │  │
└───────────────────┘      └────────────────┘  └─▶ Adyen
                                  │
                           ┌──────▼─────────┐
                           │  Lago Worker   │
                           │  (Background)  │
                           └────────────────┘
                                  │
                           ┌──────▼─────────┐
                           │  Lago Front    │
                           │  Port 3001     │
                           │  (Admin UI)    │
                           └────────────────┘
```

## Services

### 1. **Lago API** (`lago-api`)
- **Port**: 3100
- **Technology**: Ruby (Rails)
- **Purpose**: REST API for billing operations
- **Endpoints**:
  - `/api/v1/customers` - Customer management
  - `/api/v1/subscriptions` - Subscription management
  - `/api/v1/plans` - Plan/pricing management
  - `/api/v1/invoices` - Invoice operations
  - `/api/v1/events` - Usage tracking

### 2. **Lago Worker** (`lago-worker`)
- **Technology**: Ruby (Sidekiq)
- **Purpose**: Background job processing
- **Handles**:
  - Invoice generation
  - Payment processing
  - Email notifications
  - Webhook retries

### 3. **Lago Front** (`lago-front`)
- **Port**: 3001
- **Technology**: React
- **Purpose**: Admin dashboard
- **Access**: http://localhost:3001
- **Features**:
  - Customer management
  - Plan configuration
  - Invoice viewing
  - Analytics

## Setup

### 1. Environment Variables

Copy the example environment file:

```bash
cp env.example .env
```

### 2. Configure Lago Keys

Generate secure encryption keys:

```bash
# Generate random keys (32+ characters)
openssl rand -hex 32
```

Update `.env` with secure keys:

```env
# Lago Configuration
LAGO_SECRET_KEY_BASE=your-generated-secret-key-base
LAGO_ENCRYPTION_PRIMARY_KEY=your-generated-encryption-key
LAGO_ENCRYPTION_DETERMINISTIC_KEY=your-generated-deterministic-key
LAGO_ENCRYPTION_KEY_DERIVATION_SALT=your-generated-salt

# Payment Gateway (Stripe example)
STRIPE_SECRET_KEY=sk_test_your_stripe_key
STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_key
```

### 3. Start Services

```bash
# Start all services including Lago
docker-compose up -d

# Check Lago API health
curl http://localhost:3100/health

# Check Lago Front (admin UI)
open http://localhost:3001
```

### 4. Initial Setup

1. **Access Lago Admin**: http://localhost:3001
2. **Create Organization**: First-time setup wizard
3. **Generate API Key**:
   - Go to Settings → API Keys
   - Generate new API key
   - Copy to `.env` as `LAGO_API_KEY`
4. **Configure Payment Provider**:
   - Go to Settings → Integrations
   - Add Stripe/PayPal/Adyen
   - Enter credentials

### 5. Create Your First Plan

Via API:
```bash
curl -X POST http://localhost:3100/api/v1/plans \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "plan": {
      "code": "starter",
      "name": "Starter Plan",
      "interval": "monthly",
      "amount_cents": 2900,
      "amount_currency": "USD",
      "description": "Perfect for individuals"
    }
  }'
```

Or via Admin UI:
1. Go to http://localhost:3001
2. Click "Plans" → "Add Plan"
3. Fill in details and save

## Usage in AdonisJS Backend

### BillingService API

The `BillingService` provides a clean interface to Lago:

```typescript
import BillingService from '#services/billing_service';

// Create a customer
const customer = await BillingService.createCustomer({
  externalId: user.id,
  name: user.fullName,
  email: user.email,
  currency: 'USD',
});

// Create a subscription
const subscription = await BillingService.createSubscription({
  externalCustomerId: user.id,
  planCode: 'starter',
  name: 'Starter Subscription',
});

// Get customer invoices
const invoices = await BillingService.getInvoices(user.id);

// Cancel subscription
await BillingService.cancelSubscription(subscription.external_id);
```

### Example: Subscription Flow

```typescript
// apps/backend/app/controllers/subscriptions_controller.ts
import type { HttpContext } from '@adonisjs/core/http';
import BillingService from '#services/billing_service';

export default class SubscriptionsController {
  /**
   * Subscribe user to a plan
   */
  async subscribe({ request, auth, response }: HttpContext) {
    const user = auth.user!;
    const { planCode } = request.only(['planCode']);

    try {
      // 1. Create customer in Lago (if not exists)
      let customer = await BillingService.getCustomer(user.id);

      if (!customer) {
        customer = await BillingService.createCustomer({
          externalId: user.id,
          name: user.fullName,
          email: user.email,
          currency: 'USD',
        });
      }

      // 2. Create subscription
      const subscription = await BillingService.createSubscription({
        externalCustomerId: user.id,
        planCode: planCode,
        name: `${planCode} subscription`,
      });

      // 3. Update user record
      user.subscriptionId = subscription.lago_id;
      user.subscriptionStatus = subscription.status;
      await user.save();

      return response.ok({
        success: true,
        subscription,
      });
    } catch (error) {
      console.error('Subscription error:', error);
      return response.internalServerError({
        error: 'Failed to create subscription',
      });
    }
  }

  /**
   * Cancel subscription
   */
  async cancel({ auth, response }: HttpContext) {
    const user = auth.user!;

    try {
      if (!user.subscriptionId) {
        return response.badRequest({ error: 'No active subscription' });
      }

      await BillingService.cancelSubscription(user.subscriptionId);

      user.subscriptionStatus = 'canceled';
      await user.save();

      return response.ok({ success: true });
    } catch (error) {
      console.error('Cancel error:', error);
      return response.internalServerError({
        error: 'Failed to cancel subscription',
      });
    }
  }

  /**
   * Get user's invoices
   */
  async invoices({ auth, response }: HttpContext) {
    const user = auth.user!;

    try {
      const result = await BillingService.getInvoices(user.id);
      return response.ok({
        invoices: result.invoices || [],
      });
    } catch (error) {
      console.error('Invoices error:', error);
      return response.internalServerError({
        error: 'Failed to fetch invoices',
      });
    }
  }
}
```

### Example: Usage-Based Billing

Track API calls, storage, or other metrics:

```typescript
// Track an event
await BillingService.sendEvent({
  transactionId: `evt_${Date.now()}_${user.id}`,
  externalCustomerId: user.id,
  code: 'api_calls', // Your billable metric code
  timestamp: Math.floor(Date.now() / 1000),
  properties: {
    endpoint: '/api/data',
    method: 'GET',
  },
});
```

## Payment Gateway Integration

### Stripe Integration

1. **Configure in Lago Admin**:
   - Go to Settings → Integrations
   - Add Stripe
   - Enter Secret Key and Publishable Key

2. **Link Customer to Stripe**:
```typescript
import Stripe from 'stripe';
const stripe = new Stripe(env.get('STRIPE_SECRET_KEY'));

// Create Stripe customer
const stripeCustomer = await stripe.customers.create({
  email: user.email,
  name: user.fullName,
  metadata: { userId: user.id },
});

// Link to Lago
await BillingService.linkStripeCustomer(
  user.id, // Lago external ID
  stripeCustomer.id // Stripe customer ID
);
```

3. **Handle Stripe Webhooks**:
```typescript
// apps/backend/start/routes.ts
import router from '@adonisjs/core/services/router';

router.post('/webhooks/stripe', async ({ request, response }) => {
  const sig = request.header('stripe-signature');
  const payload = request.raw();

  try {
    const event = stripe.webhooks.constructEvent(
      payload,
      sig,
      env.get('STRIPE_WEBHOOK_SECRET')
    );

    // Forward to Lago or handle locally
    switch (event.type) {
      case 'customer.subscription.updated':
        // Update subscription status
        break;
      case 'invoice.payment_succeeded':
        // Mark invoice as paid
        break;
      case 'invoice.payment_failed':
        // Handle failed payment
        break;
    }

    return response.ok({ received: true });
  } catch (err) {
    return response.badRequest({ error: 'Invalid signature' });
  }
});
```

### PayPal Integration

1. **Configure in Lago Admin**:
   - Go to Settings → Integrations
   - Add PayPal
   - Enter Client ID and Secret

2. **Link Customer**:
```typescript
await BillingService.linkPayPalCustomer(
  user.id,
  paypalCustomerId
);
```

## API Reference

### Customer Management

```typescript
// Create customer
await BillingService.createCustomer({
  externalId: 'user_123',
  name: 'John Doe',
  email: 'john@example.com',
  currency: 'USD',
  timezone: 'America/New_York',
});

// Get customer
await BillingService.getCustomer('user_123');

// Update customer
await BillingService.updateCustomer('user_123', {
  name: 'John Smith',
  metadata: { plan: 'premium' },
});

// Delete customer
await BillingService.deleteCustomer('user_123');
```

### Subscription Management

```typescript
// Create subscription
await BillingService.createSubscription({
  externalCustomerId: 'user_123',
  planCode: 'starter',
  billingTime: 'calendar', // or 'anniversary'
  subscriptionAt: '2024-01-01T00:00:00Z',
});

// Get subscription
await BillingService.getSubscription('sub_123');

// List customer subscriptions
await BillingService.getCustomerSubscriptions('user_123');

// Cancel subscription
await BillingService.cancelSubscription('sub_123');
```

### Plan Management

```typescript
// Create plan
await BillingService.createPlan({
  code: 'premium',
  name: 'Premium Plan',
  interval: 'monthly',
  amountCents: 9900, // $99.00
  amountCurrency: 'USD',
  description: 'Full access to all features',
});

// Get plan
await BillingService.getPlan('premium');

// List all plans
await BillingService.getPlans();

// Update plan
await BillingService.updatePlan('premium', {
  amountCents: 12900, // $129.00
});
```

### Invoice Management

```typescript
// Get customer invoices
await BillingService.getInvoices('user_123');

// Get specific invoice
await BillingService.getInvoice('invoice_123');

// Download invoice PDF
await BillingService.downloadInvoice('invoice_123');

// Retry failed payment
await BillingService.retryInvoice('invoice_123');
```

## Production Deployment

### Environment Variables

Update production environment:

```env
# Lago URLs (production)
LAGO_API_URL=https://billing.yourdomain.com
LAGO_FRONT_URL=https://billing-admin.yourdomain.com

# Strong encryption keys (generate new ones!)
LAGO_SECRET_KEY_BASE=<64+ character random string>
LAGO_ENCRYPTION_PRIMARY_KEY=<64+ character random string>
LAGO_ENCRYPTION_DETERMINISTIC_KEY=<64+ character random string>
LAGO_ENCRYPTION_KEY_DERIVATION_SALT=<64+ character random string>

# Production payment keys
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### Database Backup

```bash
# Backup Lago database
docker-compose exec postgres pg_dump -U postgres lago_db > lago_backup.sql

# Restore
docker-compose exec -T postgres psql -U postgres lago_db < lago_backup.sql
```

### Security Checklist

- [ ] Change all default encryption keys
- [ ] Use production payment gateway keys
- [ ] Enable HTTPS for Lago API and Front
- [ ] Restrict Lago Admin access (IP whitelist)
- [ ] Enable database encryption at rest
- [ ] Set up monitoring and alerts
- [ ] Configure backup strategy

## Troubleshooting

### Lago API not starting

```bash
# Check logs
docker-compose logs lago-api

# Check database connection
docker-compose exec lago-api rails db:version

# Run migrations
docker-compose exec lago-api rails db:migrate
```

### Invoices not generating

```bash
# Check worker logs
docker-compose logs lago-worker

# Check job queue
docker-compose exec lago-api rails console
# > Sidekiq::Queue.all.each { |q| puts "#{q.name}: #{q.size}" }
```

### Payment gateway not working

1. Check integration settings in Lago Admin
2. Verify API keys are correct
3. Check webhook URLs are accessible
4. Review payment gateway logs

## Additional Resources

- [Lago Documentation](https://docs.getlago.com/)
- [Lago GitHub](https://github.com/getlago/lago)
- [Lago API Reference](https://doc.getlago.com/api-reference/intro)
- [Stripe Integration Guide](https://docs.getlago.com/integrations/stripe)
- [Usage-Based Billing](https://docs.getlago.com/guide/billable-metrics/usage-based)

## Support

- **Lago Community**: https://www.getlago.com/slack
- **Issues**: https://github.com/getlago/lago/issues
- **Discussions**: https://github.com/getlago/lago/discussions

