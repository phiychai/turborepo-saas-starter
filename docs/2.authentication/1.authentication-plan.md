---
title: 'Authentication & Registration Plan'
description: 'Complete implementation plan for Better Auth + AdonisJS authentication and authorization system'
navigation:
  title: 'Auth Plan'
  order: 1
---

# Authentication & Registration Implementation Plan

## Overview

This plan implements a **clean separation** between authentication and authorization:

- **Better Auth**: Handles authentication only (sessions, tokens, MFA, OAuth providers)
- **AdonisJS Users Table**: Canonical source of truth for ALL profile and authorization data
- **Adonis Bouncer**: Authorization policies based on Adonis User model
- **Error Logging**: Durable audit trail for auth sync failures and reconciliation
- **Hybrid Admin Approach**: AdonisJS for user/role management (canonical), Better Auth Admin plugin for sessions/impersonation
- **Why Hybrid?**: Better Auth Admin plugin roles are simple strings; Adonis Bouncer provides flexible policy-based authorization. Better Auth Organization plugin is for multi-tenant (we don't need it).

## Architecture Principles

### Separation of Concerns

1. **Better Auth** stores:
   - Session/token data
   - Authentication credentials (hashed passwords)
   - OAuth provider tokens
   - MFA configuration
   - Email verification status (via Email OTP plugin)
   - OTP codes for email verification, sign-in, and password reset

2. **AdonisJS Users Table** stores (canonical):
   - Profile data (name, email, avatar)
   - Roles and permissions
   - Application-specific preferences
   - Account status (isActive)
   - Link to Better Auth user (`better_auth_user_id`)

3. **Authorization** is handled by:
   - Adonis Bouncer with policies/abilities
   - Based on Adonis User model (not Better Auth user)

### Data Flow

```
Sign-Up/Sign-In Flow:
1. Better Auth creates/validates session
2. onAfterSignUp/onAfterSignIn hook fires
3. Upsert Adonis User from Better Auth profile
4. Store Adonis user ID in Better Auth session metadata
5. Return combined user profile via /me endpoint

Request Flow:
1. Request arrives with Better Auth session cookie
2. Auth middleware validates Better Auth session
3. Extract adonisUserId from session metadata
4. Load Adonis User model
5. Set ctx.auth.user = Adonis User
6. Controllers use ctx.auth.user for authorization
```

## Implementation Milestones

### [Milestone 1: Database Schema & User Model](./2.milestone-1-database-schema.md)
**Status**: Not Started
**Estimated Time**: 2-3 hours

- Update users table migration
- Add `better_auth_user_id` field
- Add profile fields (firstName, lastName, username)
- Add account lockout fields (failedAttempts, lockedUntil)
- Update User model with new fields
- Configure Better Auth Username Plugin
- Create frontend username checker component (using Better Auth client)
- Create auth_sync_errors table for error logging

**Deliverables**:
- Migration files
- Updated User model
- Better Auth Username Plugin configuration
- Frontend username checker component (using Better Auth)
- Error logging model

---

### [Milestone 2: Better Auth Hooks & User Synchronization](./3.milestone-2-user-sync.md)
**Status**: Not Started
**Estimated Time**: 3-4 hours

- Configure Better Auth hooks (onAfterSignUp, onAfterSignIn)
- Configure account lockout hooks (afterFailedSignIn, beforeSignIn)
- Create user sync service
- Implement upsert logic (Better Auth → Adonis)
- Handle OAuth profile data mapping
- Sync username from Better Auth Username Plugin
- Error handling and logging

**Deliverables**:
- Better Auth configuration with hooks (including account lockout)
- User sync service
- Account lockout implementation
- Error logging integration

---

### [Milestone 3: Auth Middleware & Session Integration](./4.milestone-3-auth-middleware.md)
**Status**: Not Started
**Estimated Time**: 2-3 hours

- Update auth middleware to validate Better Auth sessions
- Extract adonisUserId from session metadata
- Load Adonis User model
- Set ctx.auth.user for controllers
- Handle missing mappings gracefully
- Log errors to auth_sync_errors table

**Deliverables**:
- Updated auth middleware
- Session validation logic
- Error handling

---

### [Milestone 4: Bouncer Setup & Authorization](./5.milestone-4-bouncer.md)
**Status**: Not Started
**Estimated Time**: 2-3 hours

- Install and configure @adonisjs/bouncer
- Create initial abilities (manageUsers, editProfile, etc.)
- Create policies for resources
- Update controllers to use Bouncer
- Test authorization checks

**Deliverables**:
- Bouncer configuration
- Abilities and policies
- Updated controllers with authorization

---

### [Milestone 5: /me Endpoint & User Profile DTO](./6.milestone-5-me-endpoint.md)
**Status**: Not Started
**Estimated Time**: 2-3 hours

- Create GET /api/user/me endpoint
- Build DTO combining Adonis User + Better Auth metadata
- Return merged user profile
- Include auth metadata (provider, MFA status, token expiry)
- Exclude sensitive internal data

**Deliverables**:
- /me endpoint implementation
- User profile DTO
- Updated frontend composable

---

### [Milestone 6: Error Logging & Reconciliation](./7.milestone-6-error-logging.md)
**Status**: Not Started
**Estimated Time**: 3-4 hours

- Create auth_sync_errors migration
- Implement error logging service
- Log failed upserts, missing mappings, token inconsistencies
- Create background retry job
- Build admin UI for error inspection
- Add alerts/metrics for failures

**Deliverables**:
- Error logging service
- Retry job implementation
- Admin dashboard for errors

---

### [Milestone 7: Email Verification & OTP System](./8.milestone-7-email-verification.md)
**Status**: Not Started
**Estimated Time**: 2-3 hours

- Configure Better Auth Email OTP plugin
- Configure email service provider (Resend/SendGrid/SMTP) for OTP delivery
- Create email templates for OTP (verification, sign-in, password reset)
- Create verification/OTP UI pages
- Update signup flow with email verification OTP
- Configure OTP for password reset (optional)

**Deliverables**:
- Better Auth Email OTP plugin configuration
- Email service integration for OTP delivery
- OTP email templates
- Verification/OTP UI pages
- Resend OTP functionality (handled by Better Auth)

---

### [Milestone 8: Password Security & Validation](./9.milestone-8-password-security.md)
**Status**: Not Started
**Estimated Time**: 2-3 hours

- Configure Better Auth Have I Been Pwned plugin (checks compromised passwords)
- Install and configure zxcvbn library for password strength
- Create password validation service (integrates zxcvbn)
- Integrate password validation via Better Auth hooks
- Create password strength meter component
- Update signup/password forms

**Deliverables**:
- Better Auth Have I Been Pwned plugin configuration
- Password validator service (zxcvbn integration)
- Password strength meter component
- Better Auth hooks integration for password validation

---

### [Milestone 9: Admin Management & User Operations](./9.milestone-9-admin-management.md)
**Status**: Not Started
**Estimated Time**: 4-5 hours

- Configure Better Auth Admin plugin (limited use for sessions/impersonation)
- Create AdonisJS admin controller (user CRUD, roles, permissions)
- Implement session management using Better Auth Admin plugin
- Create sync service (AdonisJS → Better Auth for roles/bans)
- Implement authorization checks with Bouncer
- Optional: Impersonation feature

**Deliverables**:
- Better Auth Admin plugin configuration
- AdonisJS admin controller with user management
- Session management endpoints (Better Auth)
- Sync service for role/ban changes
- Authorization policies for admin operations
- Optional: Impersonation implementation

---

## Testing Strategy

### Unit Tests
- User sync service logic
- Bouncer abilities
- Error logging service

### Integration Tests
- Sign-up flow (Better Auth → Adonis sync)
- Sign-in flow (session → Adonis user loading)
- /me endpoint response
- Authorization checks

### E2E Tests
- Complete registration flow
- Login flow
- Profile access
- Protected routes

## Security Considerations

### Session & Authentication Security

1. **Session Security**: Better Auth handles session security with automatic expiration
2. **CSRF Protection**: Better Auth includes CSRF protection via SameSite cookies (configured as `lax`)
3. **Session Expiration**: Sessions expire after 7 days, refresh after 1 day of inactivity
4. **Authorization**: All checks use Adonis User (single source of truth)

### Rate Limiting & Abuse Prevention

1. **Better Auth Built-in Rate Limiting**: Better Auth includes built-in rate limiting for all auth endpoints
2. **Username Check**: Rate limiting handled by Better Auth Username Plugin automatically
3. **Auth Endpoints**: Rate limited via Better Auth (with Nginx as defense-in-depth)
4. **Account Lockout**: Implemented via Better Auth hooks (afterFailedSignIn) - 15-minute lockout after 5 failed attempts
5. **Password Reset**: Rate limited by Better Auth

### Data Protection

1. **Error Logging**:
   - Email addresses are hashed before storage (one-way bcrypt hash)
   - IP addresses are hashed before storage (GDPR compliance)
   - Sensitive fields (passwords, tokens) are redacted from payloads
   - Payloads truncated to 1KB max
2. **Input Validation**: All user input validated and sanitized before processing
3. **Data Retention**: Error logs automatically deleted after 90 days
4. **OAuth Tokens**: Encrypted at rest (handled by Better Auth)

### Username Security

1. **Better Auth Username Plugin**: Handles all username validation, availability checking, and security
2. **Enumeration Prevention**: Built into Better Auth Username Plugin
3. **Rate Limiting**: Handled by Better Auth automatically
4. **Reserved Usernames**: Configured in Better Auth Username Plugin
5. **Normalization**: Automatic via Better Auth (prevents duplicates)
6. **Validation Rules**: Customizable via Better Auth plugin configuration

### Password Security

1. **Better Auth Have I Been Pwned Plugin**: Checks passwords against known data breaches automatically
2. **Password Strength**: Validated using zxcvbn library (Milestone 8)
3. **Compromised Password Detection**: Better Auth Have I Been Pwned plugin prevents use of breached passwords
4. **Password Reset**:
   - Can use Better Auth Email OTP plugin for password reset
   - Or use Better Auth's built-in password reset (if not using OTP)
   - Cryptographically secure tokens/OTPs (single-use)
   - Rate limited to prevent abuse

### Email Verification & OTP

1. **Better Auth Email OTP Plugin**: Handles email verification, sign-in with OTP, and password reset OTP
2. **Secure OTPs**: Cryptographically secure one-time passwords
3. **OTP Expiration**: Configurable expiration (typically 5-10 minutes)
4. **Single-Use OTPs**: OTPs invalidated after use
5. **Rate Limiting**: Handled by Better Auth automatically
6. **Multiple Use Cases**: Can be used for email verification, sign-in, and password reset

### Admin Operations

1. **User Management**: Handled by AdonisJS (canonical source for roles/permissions)
2. **Session Management**: Uses Better Auth Admin plugin (Better Auth knows its sessions)
3. **Role Management**: AdonisJS is source of truth, syncs to Better Auth
4. **Impersonation**: Optional, uses Better Auth Admin plugin for secure impersonation
5. **Authorization**: All admin operations protected with Bouncer policies

**Why Not Use Better Auth Role Systems Fully?**
- **Better Auth Admin Plugin**: Provides simple string roles (`"admin"`, `"user"`), but we need Bouncer's flexible policy-based authorization for complex abilities
- **Better Auth Organization Plugin**: Designed for multi-tenant organizations/teams, which we don't need (we have simple global roles)
- **Hybrid Approach**: Best of both worlds - Bouncer for flexible authorization, Better Auth Admin for session management

### Audit & Monitoring

1. **Authorization Changes**: All role/permission changes logged with audit trail
2. **Failed Login Attempts**: Logged and monitored for suspicious patterns
3. **Error Monitoring**: Alert on high failure rates in auth sync
4. **Access Logs**: Admin access to error logs is audited
5. **Admin Operations**: All admin actions (create, update, delete users) logged
6. **Impersonation**: All impersonation events logged with audit trail

### Compliance

1. **GDPR**: IP addresses hashed before storage, data retention policies implemented
2. **Data Minimization**: Only necessary data collected and stored
3. **Right to Deletion**: User data can be deleted on request

## Migration Path

### For Existing Users

1. Create migration to backfill `better_auth_user_id` for existing users
2. Run reconciliation job to match Better Auth users with Adonis users
3. Handle edge cases (multiple Better Auth users per email, orphaned records)

## Success Criteria

- [ ] Users can register via Better Auth and profile syncs to Adonis
- [ ] Users can sign in and session maps to Adonis User
- [ ] /me endpoint returns merged profile data
- [ ] Authorization works via Bouncer using Adonis User
- [ ] All sync errors are logged and can be retried
- [ ] OAuth users sync correctly to Adonis
- [ ] No data loss during migration
- [ ] Admin operations work (user CRUD, role management)
- [ ] Session management works via Better Auth Admin plugin
- [ ] Role changes sync from AdonisJS to Better Auth

## Next Steps

Start with [Milestone 1: Database Schema & User Model](./2.milestone-1-database-schema.md)

