
This guide walks you through deploying the Turborepo SaaS Starter to production with AdonisJS as the API gateway.

## Architecture Overview

```
Internet → Nginx (443/80) → AdonisJS (3333) → {Directus, Lago, PostgreSQL}
                          ↓
                        Nuxt (3000)
```

## Prerequisites

- Docker & Docker Compose installed
- Domain name configured with DNS pointing to your server
- SSL certificates (Let's Encrypt recommended)
- Server with at least 4GB RAM and 2 CPU cores

## Quick Start

### 1. Clone and Setup

```bash
git clone <your-repo>
cd turborepo-saas-starter
cp env.example .env
```

### 2. Configure Environment Variables

Edit `.env` file with your production values:

```bash
# Critical settings to change:
NODE_ENV=production
POSTGRES_PASSWORD=<strong-password>
APP_KEY=<generate-with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))">
DIRECTUS_SECRET=<generate-random-secret>
DIRECTUS_ADMIN_PASSWORD=<strong-password>
DIRECTUS_STATIC_TOKEN=<generate-random-token>
JWT_SECRET=<generate-random-secret>

# Update URLs
NUXT_PUBLIC_SITE_URL=https://yourdomain.com
NUXT_PUBLIC_API_URL=https://api.yourdomain.com
DIRECTUS_PUBLIC_URL=https://cms.yourdomain.com
```

### 3. Initialize Database

```bash
# Make the init script executable
chmod +x scripts/init-db.sh

# Start PostgreSQL first
docker-compose up -d postgres

# Wait for PostgreSQL to be ready
docker-compose logs -f postgres
```

### 4. Update Nginx Configuration

Edit `nginx.prod.conf` and update:
- Replace `yourdomain.com` with your actual domain
- Update SSL certificate paths
- Configure your domain-specific settings

### 5. Setup SSL Certificates

#### Option A: Let's Encrypt (Recommended)

```bash
# Install certbot
sudo apt-get update
sudo apt-get install certbot

# Generate certificates
sudo certbot certonly --standalone -d yourdomain.com -d api.yourdomain.com -d cms.yourdomain.com

# Certificates will be in /etc/letsencrypt/live/yourdomain.com/
```

#### Option B: Self-Signed (Development Only)

```bash
mkdir -p ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout ssl/private.key \
  -out ssl/certificate.crt
```

### 6. Deploy Services

```bash
# Build and start all services
pnpm docker:prod:build

# Or start without rebuilding
pnpm docker:prod

# View logs
pnpm docker:logs
```

### 7. Run Database Migrations

```bash
# Run AdonisJS migrations
docker-compose exec backend node ace migration:run

# Check migration status
docker-compose exec backend node ace migration:status
```

### 8. Create Admin User

```bash
# Access the backend container
docker-compose exec backend sh

# Create admin user
node ace

# Or use the User model directly
# You'll need to create a migration seeder for this
```

## Service Configuration

### PostgreSQL

- **Port**: 5432 (internal), not exposed externally
- **Databases**: `adonis_db`, `directus_db`, `lago_db`
- **Backups**: Configure automated backups

```bash
# Manual backup
docker-compose exec postgres pg_dump -U postgres adonis_db > backup.sql
docker-compose exec postgres pg_dump -U postgres directus_db > directus_backup.sql
docker-compose exec postgres pg_dump -U postgres lago_db > lago_backup.sql

# Restore
docker-compose exec -T postgres psql -U postgres adonis_db < backup.sql
docker-compose exec -T postgres psql -U postgres directus_db < directus_backup.sql
docker-compose exec -T postgres psql -U postgres lago_db < lago_backup.sql
```

### Redis

- **Port**: 6379 (internal)
- **Usage**: Session storage, caching
- **Persistence**: Enabled with AOF

### Directus

- **Port**: 8055 (internal)
- **Access**: Via AdonisJS proxy at `/api/cms/*`
- **Admin Panel**: Available through admin dashboard

### Lago

- **Port**: 3100 (internal), Admin Dashboard at 3001 (internal)
- **Access**: Via AdonisJS proxy at `/api/billing/*`
- **Admin Dashboard**: http://localhost:3001

### AdonisJS Backend

- **Port**: 3333 (internal), exposed via Nginx
- **Role**: API gateway, authentication, business logic
- **Endpoints**:
  - `/api/auth/*` - Authentication
  - `/api/user/*` - User management
  - `/api/cms/*` - Directus proxy
  - `/api/billing/*` - Lago proxy
  - `/docs` - Swagger documentation

### Nuxt Frontend

- **Port**: 3000 (internal), exposed via Nginx
- **Role**: SSR frontend application
- **Routes**:
  - `/` - Public pages
  - `/dashboard` - User dashboard
  - `/admin` - Admin dashboard

### Nginx

- **Ports**: 80 (HTTP), 443 (HTTPS)
- **Role**: Reverse proxy, SSL termination, load balancing
- **Features**:
  - Rate limiting
  - HTTPS enforcement
  - Security headers
  - Static asset caching

## Health Checks

Check service health:

```bash
# Check all services
docker-compose ps

# Check specific service
curl http://localhost:3333/health
curl http://localhost:3000

# View logs
docker-compose logs -f backend
docker-compose logs -f web
```

## Monitoring

### Container Stats

```bash
docker stats
```

### Log Aggregation

Configure log forwarding to services like:
- ELK Stack (Elasticsearch, Logstash, Kibana)
- Grafana Loki
- Datadog
- New Relic

### Performance Monitoring

- Setup APM (Application Performance Monitoring)
- Configure error tracking (Sentry, Rollbar)
- Database query monitoring

## Security Checklist

- [ ] Change all default passwords
- [ ] Generate strong random secrets for APP_KEY, JWT_SECRET, etc.
- [ ] Configure firewall (UFW, iptables)
- [ ] Enable HTTPS only (no HTTP)
- [ ] Setup fail2ban for brute-force protection
- [ ] Regular security updates
- [ ] Database access restricted to internal network
- [ ] Redis requires authentication in production
- [ ] CORS properly configured
- [ ] Rate limiting enabled
- [ ] Security headers configured in Nginx

## Backup Strategy

### Database Backups

```bash
# Automated daily backup script
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)

# PostgreSQL backups
docker-compose exec postgres pg_dump -U postgres adonis_db > backups/adonis_$DATE.sql
docker-compose exec postgres pg_dump -U postgres directus_db > backups/directus_$DATE.sql
docker-compose exec postgres pg_dump -U postgres lago_db > backups/lago_$DATE.sql
```

### File Backups

- Directus uploads: `apps/cms/directus/uploads/`
- Application data
- SSL certificates

## Scaling

### Horizontal Scaling

- Use Docker Swarm or Kubernetes
- Setup load balancer
- Session storage in Redis (already configured)
- Shared file storage for Directus uploads (S3, NFS)

### Vertical Scaling

Adjust Docker resource limits in `docker-compose.prod.yml`:

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

## Troubleshooting

### Services Won't Start

```bash
# Check logs
docker-compose logs

# Restart specific service
docker-compose restart backend

# Rebuild and restart
docker-compose up -d --build backend
```

### Database Connection Issues

```bash
# Check PostgreSQL is running
docker-compose ps postgres

# Check connection from backend
docker-compose exec backend node ace db:check

# View PostgreSQL logs
docker-compose logs postgres
```

### Nginx Configuration Errors

```bash
# Test Nginx configuration
docker-compose exec nginx nginx -t

# Reload Nginx
docker-compose exec nginx nginx -s reload
```

## Updates & Maintenance

### Update Application

```bash
# Pull latest code
git pull

# Rebuild services
pnpm docker:prod:build

# Run migrations
docker-compose exec backend node ace migration:run
```

### Update Dependencies

```bash
# Update npm packages
pnpm update

# Rebuild containers
docker-compose build --no-cache
```

## Performance Optimization

1. **Enable Caching**
   - Redis for API responses
   - Nginx for static assets
   - Directus cache enabled

2. **Database Optimization**
   - Add indexes for frequently queried fields
   - Regular VACUUM and ANALYZE
   - Connection pooling configured

3. **CDN Integration**
   - Serve static assets from CDN
   - Directus media through CDN

4. **Monitoring**
   - Setup alerts for high CPU/memory
   - Monitor response times
   - Track error rates

## Support

For issues and questions:
- GitHub Issues
- Documentation
- Community Discord

---

**Last Updated**: 2025
**Version**: 1.0.0

