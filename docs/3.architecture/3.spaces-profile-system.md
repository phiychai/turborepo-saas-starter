---
title: 'Spaces & Profile System'
description: 'Substack/Medium-like content organization with user spaces and public profiles'
navigation:
  title: 'Spaces & Profiles'
  order: 3
---

# Spaces & Profile System

> **⚠️ Future Implementation**: This feature is planned for future development and is not currently implemented. This documentation serves as a design specification for when the feature is implemented.

## Overview

The Spaces & Profile system will enable a Substack/Medium-like content organization where users can create multiple "spaces" (collections) to organize their posts. Each user will have a public profile page that displays their spaces and recent content.

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    User Profile                        │
│                  /@username                            │
│  ┌─────────────────────────────────────────────────┐  │
│  │  User Info (name, bio, avatar)                  │  │
│  │  Spaces List                                    │  │
│  │  Recent Posts (across all spaces)               │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   General    │ │   Space 1    │ │   Space 2    │
│   Articles   │ │              │ │              │
│ /@u/article  │ │ /@u/space1   │ │ /@u/space2   │
└──────────────┘ └──────────────┘ └──────────────┘
```

## Core Concepts

### Spaces

A **Space** is a user-owned collection for organizing posts. Think of it like a Substack publication or Medium publication.

**Key Features:**
- Each user can create multiple spaces
- Each space has a unique slug (URL-friendly identifier)
- One space can be marked as "default" for general articles
- Spaces are owned by users (one-to-many relationship)
- Posts belong to a space (many-to-one relationship)

### Profile Pages

A **Profile Page** (`/@username`) is a public page that displays:
- User information (name, bio, avatar)
- All spaces owned by the user
- Recent posts across all spaces

### URL Structure

```
/@username                    → User profile page
/@username/article/[slug]     → General article (from default space)
/@username/[spaceSlug]        → Space listing page
/@username/[spaceSlug]/[slug] → Post within a specific space
```

## Data Storage

**Spaces are stored in Directus**, not in AdonisJS. The `spaces` collection is a Directus collection that lives in the Directus database.

**Why AdonisJS for creation?**
- AdonisJS acts as the **API gateway** with authentication
- Validates requests (slug format, reserved slugs, ownership)
- Resolves user identity (maps AdonisJS user → Directus user)
- Enforces business rules before creating in Directus
- Provides a consistent authenticated API interface

**Flow:**
```
Client → AdonisJS API (validates/auth) → Directus (stores data)
```

## Data Model

### Directus Collections

#### `spaces` Collection

```typescript
interface Space {
  id: string;                    // UUID primary key
  slug: string;                  // URL-friendly identifier (unique per owner)
  name: string;                  // Display name
  description?: string;          // Optional description
  owner: DirectusUser;           // User who owns this space
  is_default: boolean;           // If true, this is the default space for articles
  posts?: Post[];                // Posts in this space (O2M relation)
  date_created: string;
  user_created: DirectusUser;
  date_updated: string;
  user_updated: DirectusUser;
}
```

#### `posts` Collection (Updated)

The `posts` collection now includes a `space` field:

```typescript
interface Post {
  // ... existing fields ...
  space?: Space | string | null;  // The space this post belongs to
  // If empty, defaults to author's default 'articles' space
}
```

### Relationships

```
directus_users (1) ──< (many) spaces
spaces (1) ──< (many) posts
directus_users (1) ──< (many) posts (author)
```

## API Endpoints

### Public Endpoints (Nuxt Server API)

#### Get User Profile

**Endpoint:** `GET /api/users/[username]`

**Response:**
```json
{
  "user": {
    "id": 1,
    "username": "johndoe",
    "firstName": "John",
    "lastName": "Doe",
    "fullName": "John Doe",
    "avatarUrl": "https://...",
    "bio": "Writer and developer",
    "email": "john@example.com"
  },
  "spaces": [
    {
      "id": "uuid",
      "slug": "article",
      "name": "John's Articles",
      "description": "Default space for general articles",
      "is_default": true
    }
  ],
  "recentPosts": [
    {
      "id": "uuid",
      "title": "My First Post",
      "slug": "my-first-post",
      "description": "...",
      "published_at": "2024-01-01T00:00:00Z",
      "space": {
        "id": "uuid",
        "slug": "article",
        "name": "John's Articles",
        "is_default": true
      }
    }
  ]
}
```

#### Get User's Spaces

**Endpoint:** `GET /api/users/[username]/spaces`

**Response:**
```json
{
  "spaces": [
    {
      "id": "uuid",
      "slug": "article",
      "name": "John's Articles",
      "description": "Default space for general articles",
      "is_default": true
    }
  ]
}
```

#### Get General Article

**Endpoint:** `GET /api/users/[username]/articles/[slug]`

Fetches an article from the user's default space.

#### Get Space Posts

**Endpoint:** `GET /api/users/[username]/spaces/[spaceSlug]/posts`

**Query Parameters:**
- `limit` (default: 12)
- `page` (default: 1)

**Response:**
```json
{
  "space": {
    "id": "uuid",
    "slug": "tech-blog",
    "name": "Tech Blog",
    "description": "Technology articles"
  },
  "posts": [...],
  "count": 25
}
```

#### Get Space Post

**Endpoint:** `GET /api/users/[username]/spaces/[spaceSlug]/posts/[slug]`

**Response:**
```json
{
  "post": {...},
  "space": {...},
  "relatedPosts": [...]
}
```

### Authenticated Endpoints (AdonisJS)

These endpoints are handled by AdonisJS but **store data in Directus**.

#### List User's Spaces

**Endpoint:** `GET /api/user/spaces`

**Authentication:** Required

**Flow:**
1. AdonisJS validates authentication
2. Resolves Directus user ID from session
3. Queries Directus `spaces` collection
4. Returns user's spaces

**Response:**
```json
{
  "spaces": [...]
}
```

#### Create Space

**Endpoint:** `POST /api/user/spaces`

**Authentication:** Required

**Request Body:**
```json
{
  "slug": "my-space",
  "name": "My Space",
  "description": "Optional description"
}
```

**Flow:**
1. AdonisJS validates authentication
2. Validates slug format and reserved slugs
3. Resolves Directus user ID from session
4. Checks for duplicate slug (per user)
5. **Creates space in Directus** via `directusService.createItem('spaces', ...)`
6. Returns created space

**Validation:**
- `slug`: Required, must match `/^[a-z0-9-]+$/`
- `name`: Required
- Reserved slugs: `article`, `articles`, `blog`, `admin`, `dashboard`, `settings`, `login`, `signup`, `api`, `docs`, `explore`, `library`, `changelog`

**Storage:** Space is stored in Directus `spaces` collection

#### Update Space

**Endpoint:** `PATCH /api/user/spaces/:id`

**Authentication:** Required

**Request Body:**
```json
{
  "slug": "updated-slug",
  "name": "Updated Name",
  "description": "Updated description"
}
```

#### Delete Space

**Endpoint:** `DELETE /api/user/spaces/:id`

**Authentication:** Required

**Restrictions:**
- Cannot delete default space
- Cannot delete space with existing posts

### Public User Lookup

**Endpoint:** `GET /api/public/users/:username`

**Response:**
```json
{
  "id": 1,
  "username": "johndoe",
  "email": "john@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "avatarUrl": "https://...",
  "bio": "Writer and developer",
  "betterAuthUserId": "ba_123"
}
```

## Frontend Pages

### Profile Page

**File:** `apps/web/app/pages/@[username]/index.vue`

**Route:** `/@username`

**Features:**
- Displays user information (avatar, name, bio)
- Lists all user's spaces
- Shows recent posts across all spaces
- Links to individual spaces and posts

### General Article Page

**File:** `apps/web/app/pages/@[username]/article/[slug].vue`

**Route:** `/@username/article/[slug]`

**Features:**
- Displays article from user's default space
- Similar to blog post page but with user context

### Space Listing Page

**File:** `apps/web/app/pages/@[username]/[spaceSlug]/index.vue`

**Route:** `/@username/[spaceSlug]`

**Features:**
- Lists all posts in a specific space
- Shows space information
- Pagination support

### Space Post Page

**File:** `apps/web/app/pages/@[username]/[spaceSlug]/[slug].vue`

**Route:** `/@username/[spaceSlug]/[slug]`

**Features:**
- Displays individual post within a space
- Shows related posts from the same space
- Full post content with formatting

## Username Resolution

The system needs to resolve usernames (from AdonisJS) to Directus user IDs. This is handled by:

**File:** `apps/web/server/utils/resolve-username.ts`

**Flow:**
1. Query AdonisJS public API: `GET /api/public/users/:username`
2. Get user's email from AdonisJS
3. Find Directus user by email
4. Return Directus user ID

**Fallback:**
If user exists in AdonisJS but not in Directus, the profile page will still load with empty spaces/posts.

## Reserved Slugs

The following slugs are reserved and cannot be used for spaces:

- `article`, `articles`
- `blog`
- `admin`, `dashboard`, `settings`
- `login`, `signup`
- `api`, `docs`
- `explore`, `library`, `changelog`

These are validated in the `SpaceController` when creating or updating spaces.

## Default Space

Each user should have a default space (marked with `is_default: true`) for general articles. This space typically uses the slug `article`.

**Migration:** The `migrate-spaces.ts` script can create default spaces for existing users and assign existing posts to them.

## Components

### SpaceCard

**File:** `apps/web/app/components/space/SpaceCard.vue`

Displays a space card with name, description, and link to the space.

### SpaceHeader

**File:** `apps/web/app/components/space/SpaceHeader.vue`

Displays space header with name, description, and post count.

### SpaceSelector

**File:** `apps/web/app/components/space/SpaceSelector.vue`

Dropdown component for selecting a space (e.g., when creating a post).

## Route Handling

The catch-all route (`[...permalink].vue`) excludes routes starting with `@` to ensure space/profile routes take precedence:

```typescript
// Exclude @username routes - these are handled by specific pages
if (route.path.startsWith('/@')) {
  throw createError({ statusCode: 404, statusMessage: 'Page not found', fatal: true });
}
```

## Sitemap Integration

The sitemap generator (`/api/sitemap`) includes:
- Profile pages: `/@username`
- Article pages: `/@username/article/[slug]`
- Space post pages: `/@username/[spaceSlug]/[slug]`

## Migration

For existing installations, run the migration script to:
1. Create default "articles" spaces for all existing users
2. Assign existing posts to their author's default space

**File:** `apps/web/server/utils/migrate-spaces.ts`

## Future Enhancements

### Subdomain Routing

The system is designed to support subdomain routing in the future:
- Current: `domain.com/@username/space`
- Future: `username.domain.com/space`

The path-based routing is implemented first, with subdomain support planned for later.

### Space Settings

Future features may include:
- Custom space themes
- Space-level permissions
- Space analytics
- Space subscriptions

## Security Considerations

1. **Ownership Verification**: All space operations verify that the authenticated user owns the space
2. **Reserved Slugs**: Prevents conflicts with system routes
3. **Public Profile Data**: Only public information is exposed (no sensitive data)
4. **Username Validation**: Usernames are validated to prevent injection attacks

## Error Handling

- **404**: User not found, space not found, post not found
- **400**: Invalid slug format, missing required fields
- **403**: User doesn't own the space
- **409**: Slug already exists for user
- **500**: Server errors with detailed logging

## Testing

To test the system:

1. **Create a user** in AdonisJS with a username
2. **Ensure user is active** (`isActive: true`)
3. **Sync user to Directus** (or create Directus user with matching email)
4. **Create a space** via `POST /api/user/spaces`
5. **Create posts** in Directus and assign them to the space
6. **Visit** `/@username` to see the profile page

## Related Documentation

- [API Architecture](./2.api-architecture.md) - Overall API structure
- [Routing System](./6.routing-system.md) - Nuxt routing details
- [Authentication](../2.authentication/authentication.md) - User authentication

