---
title: 'Pinia State Management'
description: 'Comprehensive guide to state management with Pinia stores'
navigation:
  title: 'Pinia Stores'
  order: 4
---

# Pinia State Management Guide

This guide covers the state management architecture using Pinia stores in the application.

## Overview

**Pinia** is the official state management library for Vue.js and Nuxt.js. It provides:

- ‚úÖ Type-safe stores with full TypeScript support
- ‚úÖ Devtools integration for debugging
- ‚úÖ Hot module replacement (HMR)
- ‚úÖ Plugin system for extending functionality
- ‚úÖ Persistence support (localStorage/sessionStorage)
- ‚úÖ Server-side rendering (SSR) compatible

## Store Architecture

The application uses 4 main Pinia stores:

```
stores/
‚îú‚îÄ‚îÄ auth.ts       # Authentication & session management
‚îú‚îÄ‚îÄ user.ts       # User preferences & profile data
‚îú‚îÄ‚îÄ billing.ts    # Subscriptions & invoices
‚îî‚îÄ‚îÄ ui.ts         # UI state (sidebar, theme, notifications)
```

## Store Modules

### 1. Auth Store (`stores/auth.ts`)

Manages authentication state and user sessions.

**State:**
```typescript
interface AuthState {
  user: User | null;
  loading: boolean;
  initialized: boolean;
}
```

**Getters:**
- `isAuthenticated` - Whether user is logged in
- `currentUser` - Current user object
- `isLoading` - Loading state

**Actions:**
- `login(email, password)` - Login with email/password
- `register(data)` - Register new user
- `logout()` - Logout current user
- `fetchUser()` - Fetch current session
- `updateProfile(data)` - Update user profile
- `changePassword(old, new)` - Change password
- `clearAuth()` - Clear auth state

**Usage:**

```vue
<script setup lang="ts">
const authStore = useAuthStore();

// Access state
const user = computed(() => authStore.user);
const isAuthenticated = computed(() => authStore.isAuthenticated);

// Call actions
async function handleLogin() {
  const result = await authStore.login(email.value, password.value);

  if (result.success) {
    // Navigate to dashboard
    await navigateTo('/dashboard');
  } else {
    // Show error
    toast.error(result.error);
  }
}
</script>
```

### 2. User Store (`stores/user.ts`)

Manages user preferences and profile data.

**State:**
```typescript
interface UserState {
  preferences: UserPreferences | null;
  loading: boolean;
}

interface UserPreferences {
  emailNotifications: boolean;
  marketingEmails: boolean;
  language: string;
  timezone: string;
}
```

**Actions:**
- `fetchPreferences()` - Load user preferences
- `updatePreferences(updates)` - Update preferences
- `clearUserData()` - Clear user data on logout

**Usage:**

```vue
<script setup lang="ts">
const userStore = useUserStore();

// Fetch preferences on mount
onMounted(async () => {
  await userStore.fetchPreferences();
});

// Update preferences
async function toggleNotifications() {
  await userStore.updatePreferences({
    emailNotifications: !userStore.preferences?.emailNotifications
  });
}
</script>
```

### 3. Billing Store (`stores/billing.ts`)

Manages subscription plans, subscriptions, and invoices.

**State:**
```typescript
interface BillingState {
  plans: Plan[];
  subscriptions: Subscription[];
  invoices: Invoice[];
  currentSubscription: Subscription | null;
  loading: boolean;
  plansLoading: boolean;
  subscriptionsLoading: boolean;
  invoicesLoading: boolean;
}
```

**Getters:**
- `availablePlans` - All available plans
- `activeSubscription` - Current active subscription
- `hasActiveSubscription` - Whether user has active subscription
- `recentInvoices` - Last 5 invoices

**Actions:**
- `fetchPlans()` - Get available plans
- `fetchSubscriptions()` - Get user subscriptions
- `createSubscription(planCode)` - Subscribe to a plan
- `cancelSubscription(externalId)` - Cancel subscription
- `fetchInvoices()` - Get user invoices
- `downloadInvoice(invoiceId)` - Download invoice PDF
- `clearBillingData()` - Clear billing data on logout

**Usage:**

```vue
<script setup lang="ts">
const billingStore = useBillingStore();

// Fetch plans on mount
onMounted(async () => {
  await billingStore.fetchPlans();
});

// Subscribe to a plan
async function subscribe(planCode: string) {
  const result = await billingStore.createSubscription(planCode);

  if (result.success) {
    toast.success('Subscription created!');
  }
}

// Check subscription status
const isSubscribed = computed(() => billingStore.hasActiveSubscription);
</script>

<template>
  <div>
    <!-- Show plans -->
    <div v-for="plan in billingStore.availablePlans" :key="plan.code">
      <h3>{{ plan.name }}</h3>
      <p>${{ plan.amount_cents / 100 }}/{{ plan.interval }}</p>
      <button @click="subscribe(plan.code)">Subscribe</button>
    </div>
  </div>
</template>
```

### 4. UI Store (`stores/ui.ts`)

Manages UI state like sidebar, theme, and notifications.

**State:**
```typescript
interface UIState {
  sidebarCollapsed: boolean;
  theme: 'light' | 'dark' | 'system';
  notifications: Notification[];
  commandPaletteOpen: boolean;
  searchOpen: boolean;
}
```

**Getters:**
- `isSidebarCollapsed` - Sidebar state
- `currentTheme` - Current theme
- `unreadNotifications` - Notification count

**Actions:**
- `toggleSidebar()` - Toggle sidebar
- `setSidebarCollapsed(collapsed)` - Set sidebar state
- `setTheme(theme)` - Set theme
- `toggleTheme()` - Toggle between light/dark
- `addNotification(notification)` - Add notification
- `removeNotification(id)` - Remove notification
- `clearNotifications()` - Clear all notifications
- `toggleCommandPalette()` - Toggle command palette
- `openSearch()` / `closeSearch()` - Search modal

**Usage:**

```vue
<script setup lang="ts">
const uiStore = useUIStore();

// Toggle sidebar
function handleToggle() {
  uiStore.toggleSidebar();
}

// Add notification
function showSuccess() {
  uiStore.addNotification({
    title: 'Success!',
    description: 'Your changes have been saved.',
    type: 'success',
    timeout: 5000
  });
}
</script>

<template>
  <div>
    <!-- Sidebar toggle -->
    <button @click="handleToggle">
      {{ uiStore.isSidebarCollapsed ? 'Expand' : 'Collapse' }}
    </button>

    <!-- Theme toggle -->
    <button @click="uiStore.toggleTheme">
      {{ uiStore.currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô' }}
    </button>
  </div>
</template>
```

## Backward Compatibility

### useAuth Composable

The existing `useAuth()` composable now wraps the Pinia store for backward compatibility:

```typescript
// Old code still works
const { user, loading, login, logout } = useAuth();

// But new code should prefer the store directly
const authStore = useAuthStore();
```

### Migration Path

**Before (useState):**
```typescript
const user = useState<User | null>('auth:user', () => null);
const loading = useState<boolean>('auth:loading', () => false);

// Use directly
console.log(user.value);
```

**After (Pinia):**
```typescript
const authStore = useAuthStore();

// Access state
console.log(authStore.user);

// Or as computed
const user = computed(() => authStore.user);
```

## State Persistence

Stores automatically persist to localStorage:

**Auth Store:**
- ‚úÖ `user` - User object (persisted)
- ‚ùå `loading` - Not persisted
- ‚ùå `initialized` - Not persisted

**UI Store:**
- ‚úÖ `sidebarCollapsed` - Persisted
- ‚úÖ `theme` - Persisted
- ‚ùå `notifications` - Not persisted

**User Store:**
- ‚úÖ `preferences` - Persisted

**Billing Store:**
- ‚úÖ `currentSubscription` - Persisted

This ensures user preferences survive page reloads.

## Convenience Composable

Use `useStores()` to access all stores at once:

```typescript
const { auth, user, billing, ui } = useStores();

// Now you have all stores available
console.log(auth.user);
console.log(billing.currentSubscription);
console.log(ui.theme);
```

## Best Practices

### 1. **Direct Store Access**

For new code, prefer direct store access:

```typescript
// ‚úÖ Good
const authStore = useAuthStore();
const isAuthenticated = computed(() => authStore.isAuthenticated);

// ‚ö†Ô∏è Works but not ideal for new code
const { isAuthenticated } = useAuth();
```

### 2. **Store Actions Over Direct Mutation**

Always use actions to modify state:

```typescript
// ‚úÖ Good
authStore.login(email, password);

// ‚ùå Bad
authStore.user = newUser; // Don't do this
```

### 3. **Computed for Reactive Access**

Use computed when you need reactivity:

```typescript
// ‚úÖ Good - Updates when store changes
const user = computed(() => authStore.user);

// ‚ö†Ô∏è OK for one-time read
const userName = authStore.user?.name;
```

### 4. **Clear State on Logout**

Always clear related stores on logout:

```typescript
async function logout() {
  await authStore.logout();
  userStore.clearUserData();
  billingStore.clearBillingData();
  uiStore.clearNotifications();
}
```

### 5. **Error Handling**

Store actions return result objects for easy error handling:

```typescript
const result = await authStore.login(email, password);

if (result.success) {
  // Success path
  navigateTo('/dashboard');
} else {
  // Error path
  toast.error(result.error);
}
```

## Testing Stores

Pinia stores are easy to test:

```typescript
import { setActivePinia, createPinia } from 'pinia';
import { useAuthStore } from '~/stores/auth';

describe('Auth Store', () => {
  beforeEach(() => {
    // Create a fresh pinia instance for each test
    setActivePinia(createPinia());
  });

  it('should login user', async () => {
    const store = useAuthStore();

    const result = await store.login('test@example.com', 'password');

    expect(result.success).toBe(true);
    expect(store.isAuthenticated).toBe(true);
  });

  it('should handle login errors', async () => {
    const store = useAuthStore();

    const result = await store.login('invalid@example.com', 'wrong');

    expect(result.success).toBe(false);
    expect(result.error).toBeDefined();
  });
});
```

## DevTools

Pinia integrates with Vue DevTools for debugging:

1. Install Vue DevTools browser extension
2. Open DevTools ‚Üí Vue tab
3. Select "Pinia" in the sidebar
4. Inspect store state in real-time
5. View actions and mutations
6. Time-travel debugging

## Plugin Initialization

The auth plugin automatically initializes the auth state:

```typescript
// apps/web/app/plugins/auth.client.ts
export default defineNuxtPlugin(async () => {
  const authStore = useAuthStore();

  // Fetch user session on app load
  if (!authStore.initialized) {
    await authStore.fetchUser();
  }
});
```

This ensures the user session is restored on page load.

## SSR Considerations

Pinia works seamlessly with Nuxt SSR:

1. **Server Side:**
   - Stores are created fresh for each request
   - No state leakage between users
   - Hydration data passed to client

2. **Client Side:**
   - Stores hydrate from server state
   - Persistence kicks in after hydration
   - Subsequent navigation is instant

## Migration Checklist

If migrating from `useState` to Pinia:

- [ ] Install Pinia dependencies
- [ ] Add modules to `nuxt.config.ts`
- [ ] Create store file in `stores/`
- [ ] Define state, getters, actions
- [ ] Add persistence config
- [ ] Update components to use store
- [ ] Test all actions work
- [ ] Update tests
- [ ] Document store API

## Common Patterns

### Loading States

```typescript
// In store
async fetchData() {
  this.loading = true;
  try {
    const data = await api.get('/data');
    this.data = data;
    return { success: true, data };
  } catch (error) {
    return { success: false, error: error.message };
  } finally {
    this.loading = false;
  }
}

// In component
const { loading, fetchData } = useDataStore();

onMounted(async () => {
  await fetchData();
});
```

### Optimistic Updates

```typescript
// In store
async updateItem(id: string, changes: Partial<Item>) {
  // Optimistic update
  const oldItem = this.items.find(i => i.id === id);
  const index = this.items.findIndex(i => i.id === id);
  this.items[index] = { ...oldItem, ...changes };

  try {
    const updated = await api.patch(`/items/${id}`, changes);
    this.items[index] = updated;
    return { success: true };
  } catch (error) {
    // Revert on error
    this.items[index] = oldItem;
    return { success: false, error: error.message };
  }
}
```

### Computed from Multiple Stores

```typescript
const authStore = useAuthStore();
const billingStore = useBillingStore();

const canAccessPremiumFeatures = computed(() => {
  return authStore.isAuthenticated &&
         billingStore.hasActiveSubscription;
});
```

## Resources

- [Pinia Documentation](https://pinia.vuejs.org/)
- [Nuxt Pinia Module](https://pinia.vuejs.org/ssr/nuxt.html)
- [Pinia Plugin Persist](https://prazdevs.github.io/pinia-plugin-persistedstate/)
- [Vue Devtools](https://devtools.vuejs.org/)

## Summary

Pinia provides a robust, type-safe state management solution:

- ‚úÖ **4 stores**: auth, user, billing, ui
- ‚úÖ **Type-safe**: Full TypeScript support
- ‚úÖ **Persistent**: Survives page reloads
- ‚úÖ **SSR-ready**: Works with Nuxt SSR
- ‚úÖ **DevTools**: Debugging support
- ‚úÖ **Testable**: Easy to unit test
- ‚úÖ **Backward compatible**: `useAuth()` still works

For new features, always use Pinia stores directly for the best developer experience!

