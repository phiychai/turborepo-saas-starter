---
title: 'Smart Routing System'
description: 'Dynamic routing based on authentication status and user roles'
navigation:
  title: 'Routing System'
  order: 6
---

# Smart Routing System

This guide explains the intelligent routing system that adapts based on user authentication status and roles.

## Overview

The application uses a **smart routing system** where the same URL (`/`) serves different content based on the user's authentication status and role.

### Routing Behavior

| User Status | URL | Content Displayed | Layout |
|-------------|-----|-------------------|--------|
| **Anonymous** | `/` | Marketing homepage from Directus | `default` |
| **Authenticated (User)** | `/` | User dashboard | `dashboard` |
| **Authenticated (Admin)** | `/` → `/admin` | Admin dashboard (auto-redirect) | `dashboard` |

## Architecture

### Key Components

```
pages/
├── index.vue              # Smart homepage (marketing or dashboard)
├── admin/
│   └── index.vue          # Admin dashboard
├── dashboard/
│   ├── index.vue          # User dashboard (alternative route)
│   ├── settings/
│   ├── customers.vue
│   └── inbox.vue
├── login.vue              # Login page
└── signup.vue             # Registration page

middleware/
├── auth.ts                # Protects authenticated routes
└── admin.ts               # Protects admin-only routes
```

## Homepage (`/`) Logic

### File: `pages/index.vue`

The homepage intelligently adapts based on authentication:

```vue
<script setup lang="ts">
const authStore = useAuthStore();

// Computed properties
const isAuthenticated = computed(() => authStore.isAuthenticated);
const isAdmin = computed(() => authStore.user?.role === 'admin');

// Redirect admin users to /admin
onMounted(() => {
  if (isAuthenticated.value && isAdmin.value) {
    navigateTo('/admin');
  }
});
</script>

<template>
  <div>
    <!-- Marketing Homepage (Anonymous Users) -->
    <NuxtLayout v-if="!isAuthenticated" name="default">
      <PageBuilder :sections="pageBlocks" />
    </NuxtLayout>

    <!-- Dashboard (Authenticated Users) -->
    <NuxtLayout v-else name="dashboard">
      <UDashboardPage>
        <!-- Dashboard content -->
      </UDashboardPage>
    </NuxtLayout>
  </div>
</template>
```

### Features

**For Anonymous Users:**
- ✅ Fetches marketing content from Directus
- ✅ Uses `default` layout
- ✅ Shows hero, features, pricing, etc.
- ✅ Visual editing enabled (if Directus preview mode)

**For Authenticated Users:**
- ✅ Uses `dashboard` layout
- ✅ Shows personalized welcome message
- ✅ Quick stats (account status, member since, email)
- ✅ Quick action buttons
- ✅ Recent activity feed

**For Admin Users:**
- ✅ Auto-redirects to `/admin`
- ✅ Prevents confusion (users see user dashboard, admins see admin panel)

## Admin Routes

### Admin Dashboard (`/admin`)

Protected by the `admin` middleware - only accessible to users with `role === 'admin'`.

**File:** `pages/admin/index.vue`

```vue
<script setup lang="ts">
definePageMeta({
  layout: 'dashboard',
  middleware: 'admin', // ← Protects this route
});
</script>

<template>
  <UDashboardPage>
    <!-- Admin dashboard with stats, user management, etc. -->
  </UDashboardPage>
</template>
```

**Features:**
- ✅ System statistics (users, subscriptions, revenue, tickets)
- ✅ Quick admin actions (manage users, billing, content, analytics)
- ✅ Recent users list
- ✅ System status monitoring

### Admin Middleware

**File:** `middleware/admin.ts`

```typescript
export default defineNuxtRouteMiddleware((to, from) => {
  const authStore = useAuthStore();

  // Check authentication
  if (!authStore.isAuthenticated) {
    return navigateTo({
      path: '/login',
      query: { redirect: to.fullPath },
    });
  }

  // Check admin role
  if (authStore.user?.role !== 'admin') {
    return navigateTo('/dashboard');
  }

  // Admin verified - allow access
});
```

**Behavior:**
1. ❌ **Not authenticated** → Redirect to `/login?redirect=/admin`
2. ❌ **Authenticated but not admin** → Redirect to `/dashboard`
3. ✅ **Authenticated and admin** → Allow access

## Authentication Flow

### Login Flow

```
User visits /login
   ↓
Submits credentials
   ↓
Authentication successful
   ↓
Redirect to /
   ↓
┌─────────────┬─────────────┐
│ Regular     │ Admin User  │
│ User        │             │
├─────────────┼─────────────┤
│ Shows       │ Auto-       │
│ Dashboard   │ redirects   │
│ at /        │ to /admin   │
└─────────────┴─────────────┘
```

### Signup Flow

```
User visits /signup
   ↓
Creates account
   ↓
Auto-login
   ↓
Redirect to /
   ↓
Shows dashboard (new users are never admin by default)
```

### Logout Flow

```
User clicks logout (anywhere)
   ↓
Clear auth state
   ↓
Redirect to /
   ↓
Shows marketing homepage (anonymous)
```

## Protected Routes

### Dashboard Routes

All routes under `/dashboard/*` are protected by the `auth` middleware:

```vue
<script setup lang="ts">
// In dashboard pages
definePageMeta({
  layout: 'dashboard',
  middleware: 'auth', // ← Requires authentication
});
</script>
```

**Examples:**
- `/dashboard/settings` - User settings
- `/dashboard/billing` - Billing & subscriptions
- `/dashboard/customers` - Customer management
- `/dashboard/inbox` - Messages

### Admin Routes

All routes under `/admin/*` are protected by the `admin` middleware:

```vue
<script setup lang="ts">
// In admin pages
definePageMeta({
  layout: 'dashboard',
  middleware: 'admin', // ← Requires admin role
});
</script>
```

**Examples:**
- `/admin` - Admin dashboard
- `/admin/users` - User management (future)
- `/admin/billing` - Billing management (future)
- `/admin/content` - Content management (future)

## URL Consistency

### Why `/` Instead of `/dashboard`?

**Benefits:**
1. **Simpler URLs** - Main app is always at `/`
2. **Less Confusion** - Users don't need to remember `/dashboard`
3. **Cleaner UX** - Logo clicks go to `/` (home for everyone)
4. **Standard Pattern** - Common in modern SaaS apps

**Examples:**
- Gmail: `mail.google.com/` (not `mail.google.com/dashboard`)
- Notion: `notion.so/` (workspace, not dashboard)
- Linear: `linear.app/` (issues view)

### Alternative Routes

Users can still access dashboards via explicit routes:

```
/               → Smart route (marketing or dashboard)
/dashboard      → Explicit dashboard route
/admin          → Admin panel
```

Both `/` and `/dashboard` show the same content for authenticated users.

## Code Examples

### Check Authentication in Components

```vue
<script setup lang="ts">
const authStore = useAuthStore();

const isAuthenticated = computed(() => authStore.isAuthenticated);
const isAdmin = computed(() => authStore.user?.role === 'admin');
const userName = computed(() => authStore.user?.name || authStore.user?.email);
</script>

<template>
  <div>
    <!-- Show different content based on auth -->
    <div v-if="isAuthenticated">
      <p>Welcome, {{ userName }}!</p>
      <UButton v-if="isAdmin" to="/admin">Admin Panel</UButton>
    </div>
    <div v-else>
      <UButton to="/login">Login</UButton>
      <UButton to="/signup">Sign Up</UButton>
    </div>
  </div>
</template>
```

### Conditional Navigation

```vue
<script setup lang="ts">
const authStore = useAuthStore();

function goToHome() {
  if (authStore.isAuthenticated && authStore.user?.role === 'admin') {
    navigateTo('/admin');
  } else if (authStore.isAuthenticated) {
    navigateTo('/dashboard'); // or just '/'
  } else {
    navigateTo('/');
  }
}
</script>
```

### Protecting Custom Routes

```vue
<script setup lang="ts">
// Custom protected route
definePageMeta({
  middleware: async (to, from) => {
    const authStore = useAuthStore();

    // Custom logic
    if (!authStore.isAuthenticated) {
      return navigateTo('/login');
    }

    // Check subscription status (example)
    const billingStore = useBillingStore();
    if (!billingStore.hasActiveSubscription) {
      return navigateTo('/dashboard/billing');
    }
  }
});
</script>
```

## Navigation Components

### Header Navigation

Update header to show correct links:

```vue
<script setup lang="ts">
const authStore = useAuthStore();

const navItems = computed(() => {
  if (authStore.isAuthenticated) {
    const items = [
      { label: 'Dashboard', to: '/' },
      { label: 'Settings', to: '/dashboard/settings' },
      { label: 'Billing', to: '/dashboard/billing' },
    ];

    // Add admin link for admin users
    if (authStore.user?.role === 'admin') {
      items.unshift({ label: 'Admin', to: '/admin' });
    }

    return items;
  } else {
    return [
      { label: 'Features', to: '/#features' },
      { label: 'Pricing', to: '/pricing' },
      { label: 'Docs', to: '/docs' },
    ];
  }
});
</script>
```

### Dashboard Sidebar

```vue
<script setup lang="ts">
const authStore = useAuthStore();

const sidebarItems = [
  { label: 'Dashboard', icon: 'i-heroicons-home', to: '/' },
  { label: 'Inbox', icon: 'i-heroicons-inbox', to: '/dashboard/inbox' },
  { label: 'Customers', icon: 'i-heroicons-users', to: '/dashboard/customers' },
  { label: 'Settings', icon: 'i-heroicons-cog', to: '/dashboard/settings' },
];

// Add admin section for admin users
if (authStore.user?.role === 'admin') {
  sidebarItems.unshift({
    label: 'Admin Panel',
    icon: 'i-heroicons-shield-check',
    to: '/admin'
  });
}
</script>
```

## Testing Routes

### Manual Testing Checklist

**Anonymous User:**
- [ ] Visit `/` → See marketing homepage
- [ ] Visit `/dashboard` → Redirect to `/login`
- [ ] Visit `/admin` → Redirect to `/login`
- [ ] Login → Redirect to `/` (dashboard)

**Regular User:**
- [ ] Visit `/` → See user dashboard
- [ ] Visit `/dashboard` → See user dashboard
- [ ] Visit `/admin` → Redirect to `/dashboard`
- [ ] Logout → Redirect to `/` (marketing)

**Admin User:**
- [ ] Visit `/` → Redirect to `/admin`
- [ ] Visit `/admin` → See admin dashboard
- [ ] Visit `/dashboard` → See user dashboard (if desired)
- [ ] Logout → Redirect to `/` (marketing)

### Automated Tests

```typescript
// e2e/routing.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Smart Routing', () => {
  test('anonymous user sees marketing homepage', async ({ page }) => {
    await page.goto('/');
    await expect(page.locator('h1')).toContainText('Welcome');
  });

  test('authenticated user sees dashboard at /', async ({ page }) => {
    // Login first
    await page.goto('/login');
    // ... login flow

    await page.goto('/');
    await expect(page.locator('h1')).toContainText('Welcome back');
  });

  test('admin user redirects to /admin from /', async ({ page }) => {
    // Login as admin
    // ... login flow

    await page.goto('/');
    await expect(page).toHaveURL('/admin');
  });
});
```

## Best Practices

### 1. **Always Use Pinia Stores**

```typescript
// ✅ Good
const authStore = useAuthStore();
const isAuthenticated = computed(() => authStore.isAuthenticated);

// ❌ Bad
const { isAuthenticated } = useAuth(); // Works but not ideal for new code
```

### 2. **Use Computed for Reactive Checks**

```vue
<script setup lang="ts">
// ✅ Good - Reactive
const authStore = useAuthStore();
const isAdmin = computed(() => authStore.user?.role === 'admin');

// ❌ Bad - Not reactive
const isAdmin = authStore.user?.role === 'admin';
</script>
```

### 3. **Redirect After State Changes**

```typescript
// ✅ Good - Wait for state update
await authStore.login(email, password);
navigateTo('/');

// ❌ Bad - State might not be ready
authStore.login(email, password);
navigateTo('/'); // User might not be authenticated yet
```

### 4. **Handle Edge Cases**

```typescript
// Check if user object exists before accessing properties
const isAdmin = computed(() => authStore.user?.role === 'admin');

// Not just
const isAdmin = computed(() => authStore.user.role === 'admin'); // ❌ Can crash
```

## Troubleshooting

### Issue: Redirect Loop

**Symptom:** Page keeps redirecting between routes

**Solution:** Check middleware logic - ensure you're not creating circular redirects

```typescript
// ❌ Bad - Can cause loops
if (authStore.isAuthenticated) {
  return navigateTo('/');
}

// ✅ Good - Specific route
if (authStore.isAuthenticated) {
  return navigateTo('/dashboard');
}
```

### Issue: Admin User Sees User Dashboard

**Symptom:** Admin redirected to `/admin` but still sees user content

**Solution:** Clear browser cache and localStorage, then re-login

```bash
# In browser console
localStorage.clear();
location.reload();
```

### Issue: Layout Doesn't Update

**Symptom:** Wrong layout shows after login

**Solution:** Ensure `NuxtLayout` is reactive to `isAuthenticated`:

```vue
<!-- ✅ Good - Reactive -->
<NuxtLayout v-if="!isAuthenticated" name="default">
<NuxtLayout v-else name="dashboard">

<!-- ❌ Bad - Static -->
<NuxtLayout :name="layout">
```

## Summary

The smart routing system provides:

- ✅ **Clean URLs** - `/` is the main entry point
- ✅ **Role-based routing** - Admin users → `/admin`, users → dashboard
- ✅ **Automatic redirects** - No manual routing needed
- ✅ **Protected routes** - Middleware handles authentication
- ✅ **Flexible** - Works with marketing site + app

This creates a seamless experience where users see the right content at the right URL based on their authentication status and role!

