---
title: 'Architecture'
description: 'Production-ready architecture overview for the Turborepo SaaS Starter'
navigation:
  title: 'Architecture'
  order: 1
---

## Overview

This document describes the production-ready architecture for the Turborepo SaaS Starter, with AdonisJS serving as the central API gateway.

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                          Internet/Users                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  Nginx (80/443)│
                    │  Reverse Proxy │
                    │  SSL Termination│
                    └────────┬───────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
            ┌───────────────┐  ┌──────────────┐
            │ Nuxt Frontend │  │   AdonisJS   │
            │   (Port 3000) │  │   Backend    │
            │   SSR/SPA     │  │  (Port 3333) │
            └───────────────┘  │  API Gateway │
                               └──────┬───────┘
                                      │
                   ┌──────────────────┼──────────────────┐
                   │                  │                  │
                   ▼                  ▼                  ▼
            ┌──────────┐      ┌─────────────┐   ┌──────────────┐
            │ Directus │      │     Lago     │   │  PostgreSQL  │
            │   CMS    │      │   Billing    │   │   Database   │
            │ (8055)   │      │   (3100)     │   │    (5432)    │
            └────┬─────┘      └──────┬───────┘   └──────┬───────┘
                 │                   │                  │
                 │                   │                  │
                 │                   │                  │
                 │                   │                  │
                 │                   │                  │
                 │                                      │
                 └──────────────────┬───────────────────┘
                                    │
                                    ▼
                             ┌─────────────┐
                             │    Redis    │
                             │   Cache     │
                             │   (6379)    │
                             └─────────────┘
```

## Component Responsibilities

### 1. Nginx (Reverse Proxy)

**Purpose**: Entry point for all traffic, handles SSL termination, routing, and security.

**Responsibilities**:
- SSL/TLS certificate management
- Route `/api/*` requests to AdonisJS backend
- Route `/*` requests to Nuxt frontend
- Rate limiting and DDoS protection
- Security headers injection
- Static asset caching
- Request/response compression

**Configuration**: `nginx.conf`, `nginx.prod.conf`

### 2. AdonisJS Backend (API Gateway)

**Purpose**: Single point of entry for all API requests, handles authentication, and proxies to internal services.

**Responsibilities**:
- **Authentication & Authorization**
  - User registration and login
  - Session management (Redis-backed)
  - JWT token generation
  - Role-based access control (user, admin)

- **API Gateway**
  - Proxy requests to Directus CMS (`/api/cms/*`)
  - Proxy requests to Lago (`/api/billing/*`)
  - Inject authentication tokens for internal services
  - Request validation and transformation

- **Business Logic**
  - User profile management
  - Custom application logic
  - Form handling
  - Email notifications

- **Data Layer**
  - User data in PostgreSQL (`adonis_db`)
  - ORM (Lucid) for database operations
  - Database migrations and seeders

**Endpoints**:
```
POST   /api/auth/register          - User registration
POST   /api/auth/login             - User login
POST   /api/auth/logout            - User logout
GET    /api/auth/me                - Get current user
POST   /api/auth/change-password   - Change password

GET    /api/user/me              - Get user profile
PATCH  /api/user/me               - Update profile
GET    /api/user/users             - List all users (admin)
PATCH  /api/user/users/:id/...     - Manage users (admin)

GET    /api/cms/*                  - Directus proxy (read)
POST   /api/cms/*                  - Directus proxy (create)
PATCH  /api/cms/*                  - Directus proxy (update)
DELETE /api/cms/*                  - Directus proxy (delete)

GET    /api/billing/subscriptions  - Get user subscriptions
POST   /api/billing/subscriptions  - Create subscription
GET    /api/billing/invoices       - Get invoices
GET    /api/billing/plans          - Get available plans
...

GET    /docs                       - Swagger API documentation
GET    /health                     - Health check
```

### 3. Nuxt Frontend (Web Application)

**Purpose**: Server-side rendered frontend application with user and admin interfaces.

**Responsibilities**:
- **Public Pages**
  - Landing page
  - Blog (Nuxt Content)
  - Documentation (Nuxt Content)
  - Pricing
  - Login/Signup forms

- **User Dashboard**
  - Profile management
  - Billing & subscriptions
  - Settings

- **Admin Dashboard**
  - User management
  - Content management interface
  - Analytics (future)

- **Authentication Flow**
  - Handle login/logout UI
  - Store JWT in httpOnly cookies
  - Redirect based on auth state
  - Role-based route guards

**Technology Stack**:
- Nuxt 4 (SSR/SPA)
- Nuxt UI Pro
- Tailwind CSS
- Nuxt Content (for docs/blog)

### 4. PostgreSQL Database

**Purpose**: Persistent data storage for all services.

**PostgreSQL Databases**:
- `adonis_db` - AdonisJS application data
  - users
  - sessions
  - application-specific tables

- `directus_db` - Directus CMS data
  - collections
  - items
  - files metadata
  - directus system tables

- `lago_db` - Lago billing data
  - accounts
  - subscriptions
  - invoices
  - payments
  - usage events

**Configuration**:
- PostgreSQL instance for application, CMS, and billing data
- Connection pooling enabled
- Automated backups configured
- Replica for read scaling (optional)

### 5. Directus CMS

**Purpose**: Headless CMS for content management.

**Responsibilities**:
- Content collections management
- Media file storage
- Visual content editor
- API for content delivery
- User authentication (proxied through AdonisJS)

**Access Pattern**:
```
Frontend → AdonisJS (/api/cms/*) → Directus (8055)
```

**Features**:
- Dynamic content types
- File uploads
- Relational data
- Real-time updates
- GraphQL/REST APIs

### 6. Lago (Billing Platform)

**Purpose**: Subscription and payment management.

**Responsibilities**:
- Subscription lifecycle management
- Invoice generation
- Payment processing
- Usage-based billing
- Payment retry logic
- Multi-currency support

**Access Pattern**:
```
Frontend → AdonisJS (/api/billing/*) → Lago (3100)
```

**Features**:
- Flexible subscription plans
- Trial periods
- Proration
- Dunning management
- Analytics and reporting
- Admin dashboard at http://localhost:3001

### 7. Redis Cache

**Purpose**: In-memory cache and session storage.

**Responsibilities**:
- Session storage (AdonisJS sessions)
- API response caching
- Rate limiting counters
- Job queue (optional)
- Real-time features (optional)

**Configuration**:
- Persistence enabled (AOF)
- Password protected in production
- Connection pooling

## Data Flow Examples

### User Login Flow

```
1. User submits credentials
   └─> Nuxt (login.vue)
       └─> POST /api/auth/login → AdonisJS
           └─> Validate credentials (PostgreSQL adonis_db)
           └─> Create session (Redis)
           └─> Generate JWT
           └─> Return user data + set httpOnly cookie

2. User accesses dashboard
   └─> Nuxt middleware checks auth
       └─> GET /api/auth/me → AdonisJS
           └─> Verify session/JWT
           └─> Return user data
```

### Content Request Flow

```
1. User requests blog posts
   └─> Nuxt page (dashboard/index.vue)
       └─> GET /api/cms/collections/posts → AdonisJS
           └─> Verify authentication
           └─> Proxy to Directus with admin token
           └─> GET http://directus:8055/items/posts
           └─> Return data to Nuxt

2. Admin creates new post
   └─> Nuxt admin panel
       └─> POST /api/cms/posts → AdonisJS
           └─> Verify admin role
           └─> Proxy to Directus
           └─> POST http://directus:8055/items/posts
           └─> Return created post
```

### Subscription Flow

```
1. User subscribes to a plan
   └─> Nuxt billing page
       └─> POST /api/billing/subscriptions → AdonisJS
           └─> Verify authentication
           └─> Get/Create Lago customer
           └─> POST http://lago:3100/api/v1/subscriptions
           └─> Store subscription reference
           └─> Return subscription data

2. Lago webhook (payment failed)
   └─> POST /api/billing/webhooks → AdonisJS
       └─> Verify webhook signature
       └─> Update subscription status
       └─> Send notification email
       └─> Return 200 OK
```

## Security Layers

### Layer 1: Nginx (Entry Point)
- Rate limiting
- IP whitelisting/blacklisting
- SSL/TLS enforcement
- DDoS protection
- Security headers

### Layer 2: AdonisJS (Application)
- Authentication verification
- Authorization checks (role-based)
- Input validation (Vine validator)
- CSRF protection
- SQL injection prevention (ORM)
- XSS prevention

### Layer 3: Services (Internal)
- Internal network only (no public access)
- Service-to-service authentication
- Database credentials secured
- Redis password protected

## Deployment Strategies

### Docker Compose (Single Server)

Best for:
- Small to medium applications
- Cost-effective hosting
- Simple management

Commands:
```bash
pnpm docker:prod        # Start production stack
pnpm docker:prod:build  # Rebuild and start
```

### Docker Swarm (Multi-Node)

Best for:
- High availability
- Load balancing
- Rolling updates

Setup:
```bash
docker swarm init
docker stack deploy -c docker-compose.yml -c docker-compose.prod.yml saas-stack
```

### Kubernetes (Enterprise)

Best for:
- Large scale applications
- Auto-scaling requirements
- Complex orchestration needs

Requires:
- Kubernetes manifests
- Helm charts
- Ingress controller

## Monitoring & Observability

### Health Checks

- AdonisJS: `GET /health`
- Nuxt: TCP check on port 3000
- PostgreSQL: `pg_isready`
- Redis: `PING` command
- Directus: HTTP health endpoint
- Lago: HTTP health endpoint at http://localhost:3100/health

### Logging

Centralized logging with structured JSON:
- Application logs → stdout/stderr
- Nginx access logs
- PostgreSQL slow query logs
- Collected by Docker logging driver
- Forwarded to ELK/Loki/CloudWatch

### Metrics

Key metrics to track:
- Request rate
- Response time (p50, p95, p99)
- Error rate
- CPU/Memory usage per service
- Database connections
- Cache hit ratio
- Active users

### Alerting

Alert on:
- Service downtime
- High error rate (> 5%)
- Response time degradation
- Database connection pool exhaustion
- Disk space < 10%
- Memory usage > 90%

## Scaling Considerations

### Horizontal Scaling

Services that can scale horizontally:
- ✅ Nuxt Frontend (stateless)
- ✅ AdonisJS Backend (with Redis sessions)
- ⚠️ Directus (requires shared storage)
- ❌ PostgreSQL (use read replicas)
- ❌ Redis (use Redis Cluster)
- ⚠️ Lago (requires configuration)

### Vertical Scaling

Increase resources for:
- PostgreSQL (CPU + Memory)
- Redis (Memory)
- AdonisJS (CPU for request handling)

### Performance Optimization

1. **Database**
   - Index optimization
   - Query optimization
   - Connection pooling
   - Read replicas

2. **Caching**
   - Redis for API responses
   - CDN for static assets
   - Browser caching

3. **Load Balancing**
   - Nginx upstream servers
   - Health checks
   - Session affinity (if needed)

## Backup & Disaster Recovery

### Backup Strategy

Daily automated backups:
- PostgreSQL databases (pg_dump)
- Directus uploads folder
- Redis AOF file (for session recovery)
- Application configuration

### Recovery Plan

1. Restore PostgreSQL from backup
2. Restore Directus uploads
3. Restart services
4. Verify data integrity
5. Monitor for issues

RTO (Recovery Time Objective): < 1 hour
RPO (Recovery Point Objective): < 24 hours

## Documentation Index

### Architecture Guides

- **[API Architecture](./2.api-architecture.md)** - Hybrid API architecture using Nuxt Server API and AdonisJS Gateway
- **[Package Structure](./4.package-structure.md)** - Monorepo organization and package management
- **[Pinia State Management](./5.pinia-state-management.md)** - Frontend state management patterns
- **[Routing System](./6.routing-system.md)** - Nuxt routing and navigation

---

**Version**: 1.0.0
**Last Updated**: 2025

