---
title: 'API Architecture - Hybrid Approach'
description: 'Hybrid API architecture using Nuxt Server API and AdonisJS Gateway'
navigation:
  title: 'API Architecture'
  order: 2
---

## Overview

This project uses a **hybrid API architecture** that leverages the strengths of both Nuxt Server API (Nitro) and AdonisJS API Gateway.

## Architecture Decision

### Why Hybrid?

1. **Performance**: Direct Directus connections for public content (faster, less hops)
2. **Security**: Centralized authentication through AdonisJS for sensitive operations
3. **Flexibility**: Use the right tool for each use case

## API Routes Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client (Browser)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nuxt Server  â”‚          â”‚  AdonisJS    â”‚
â”‚ (Nitro API)  â”‚          â”‚  Gateway     â”‚
â”‚ Port 3000    â”‚          â”‚  Port 3333   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â”‚ Public                  â”‚ Authenticated
       â”‚ Read-Only               â”‚ Read/Write
       â”‚                         â”‚
       â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Directus   â”‚          â”‚ Directus +   â”‚
â”‚     CMS      â”‚          â”‚     Lago     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Route Distribution

### ðŸŸ¢ Nuxt Server API (Nitro) Routes

**Path**: `/api/*` (served by Nuxt at port 3000)

**Use for**: Public, read-only content

| Endpoint                | Purpose            | Authentication |
| ----------------------- | ------------------ | -------------- |
| `GET /api/posts`        | Blog posts list    | None (public)  |
| `GET /api/posts/[slug]` | Single blog post   | None (public)  |
| `GET /api/pages/one`    | Page content       | None (public)  |
| `GET /api/site-data`    | Site configuration | None (public)  |
| `GET /api/sitemap`      | XML sitemap        | None (public)  |
| `GET /api/search`       | Content search     | None (public)  |

**Implementation**: `apps/web/server/api/*.ts`

**Directus SDK**: Direct connection using `@directus/sdk`

```typescript
// Example: apps/web/server/api/posts/index.get.ts
import { directusServer, readItems } from '~/server/utils/directus-server';

export default defineEventHandler(async (event) => {
  const posts = await directusServer.request(
    readItems('posts', {
      fields: ['*'],
      filter: { status: { _eq: 'published' } }
    })
  );
  return posts;
});
```

### ðŸ”µ AdonisJS API Gateway Routes

**Path**: Proxied through Nginx to AdonisJS (port 3333)

**Use for**: Authenticated operations, user-specific content, billing

#### Authentication Routes
| Endpoint                    | Purpose           | Method |
| --------------------------- | ----------------- | ------ |
| `/api/auth/register`        | User registration | POST   |
| `/api/auth/login`           | User login        | POST   |
| `/api/auth/logout`          | User logout       | POST   |
| `/api/auth/me`              | Current user      | GET    |
| `/api/auth/change-password` | Change password   | POST   |

#### User Routes (Authenticated)
| Endpoint                            | Purpose                    | Method |
| ----------------------------------- | -------------------------- | ------ |
| `/api/user/me`                      | Get user profile           | GET    |
| `/api/user/me`                      | Update profile             | PATCH  |
| `/api/user/users`                   | List all users (admin)     | GET    |
| `/api/user/users/:id/toggle-status` | Toggle user status (admin) | PATCH  |

#### CMS Proxy Routes (Authenticated for write operations)
| Endpoint                               | Purpose        | Method |
| -------------------------------------- | -------------- | ------ |
| `/api/cms/collections/:collection`     | Get collection | GET    |
| `/api/cms/collections/:collection/:id` | Get item       | GET    |
| `/api/cms/*`                           | Create content | POST   |
| `/api/cms/*`                           | Update content | PATCH  |
| `/api/cms/*`                           | Delete content | DELETE |

#### Billing Routes (Always Authenticated)
| Endpoint                         | Purpose                    | Method |
| -------------------------------- | -------------------------- | ------ |
| `/api/billing/account`           | Get/create billing account | GET    |
| `/api/billing/subscriptions`     | List subscriptions         | GET    |
| `/api/billing/subscriptions`     | Create subscription        | POST   |
| `/api/billing/subscriptions/:id` | Cancel subscription        | DELETE |
| `/api/billing/invoices`          | List invoices              | GET    |
| `/api/billing/plans`             | List available plans       | GET    |
| `/api/billing/payment-methods`   | List payment methods       | GET    |
| `/api/billing/payment-methods`   | Add payment method         | POST   |

**Implementation**: `apps/backend/app/controllers/*.ts`

**Services**: Proxy through AdonisJS services with auth injection

```typescript
// Example: apps/backend/app/controllers/billing_controller.ts
export default class BillingController {
  async getSubscriptions({ response, auth }: HttpContext) {
    const user = auth.user!; // Already authenticated
    const account = await billingService.getAccountByEmail(user.email);
    const subscriptions = await billingService.getSubscriptions(account.accountId);
    return response.ok({ subscriptions });
  }
}
```

## Decision Matrix

### When to Use Nuxt Server API (Nitro)?

âœ… **YES** if:
- Content is public
- Read-only operation
- No authentication needed
- Used for SSR/SEO
- Blog, documentation, landing pages

âŒ **NO** if:
- Requires authentication
- Write/update/delete operations
- User-specific content
- Billing/payment operations
- Admin operations

### When to Use AdonisJS Gateway?

âœ… **YES** if:
- Requires authentication
- Write/update/delete operations
- User-specific content
- Billing/payment operations
- Admin operations
- Form submissions with validation
- Rate limiting needed

âŒ **NO** if:
- Public read-only content
- Already cached/static
- SSR performance critical

## Security Considerations

### Nuxt Server API (Public)
- âš ï¸ Assumes all content is public
- âš ï¸ No authentication checks
- âœ… Can use Directus permissions for basic protection
- âœ… Fast and efficient for public content

### AdonisJS Gateway (Authenticated)
- âœ… Centralized authentication
- âœ… Role-based access control
- âœ… Rate limiting
- âœ… Audit logging
- âœ… Token injection for backend services

## Migration Path

### Current State âœ…
- Nuxt Server API for public Directus content
- AdonisJS for auth, billing, user management

### Future Enhancements
1. Add caching layer to Nuxt Server API
2. Implement GraphQL endpoint in AdonisJS
3. Add webhook handlers for Lago
4. Implement real-time features with WebSockets

## Example: Form Submission Flow

### Public Contact Form
```
Browser â†’ Nuxt Server API â†’ Directus
  POST /api/forms/submit
```

### Authenticated User Form
```
Browser â†’ AdonisJS Gateway â†’ Directus
  POST /api/cms/user_submissions
  (includes user context)
```

## Lago Integration

**Always use AdonisJS** - No direct connection from Nuxt

Reasons:
1. ðŸ”’ All billing operations require authentication
2. ðŸ’³ PCI compliance considerations
3. ðŸ” Sensitive financial data
4. ðŸ“Š Audit trail needed
5. ðŸ›¡ï¸ Rate limiting critical

```typescript
// âŒ NEVER do this in Nuxt Server API
export default defineEventHandler(async (event) => {
  // DON'T connect directly to Lago from Nuxt
});

// âœ… Always proxy through AdonisJS
const { billing } = useApi();
await billing.createSubscription('premium-plan');
```

## Performance Considerations

### Nuxt Server API
- **Latency**: ~10-50ms (direct connection)
- **Caching**: Nuxt auto-caching
- **SSR**: Optimized for server-side rendering

### AdonisJS Gateway
- **Latency**: ~50-100ms (one extra hop)
- **Benefits**: Authentication, validation, business logic
- **Caching**: Redis-based session and data cache

## Development Guidelines

### Adding a New Endpoint

#### Public Content?
1. Create in `apps/web/server/api/*.ts`
2. Use `directusServer` from utils
3. No authentication needed
4. Test with `/api/*` URL

#### Authenticated Operation?
1. Create in `apps/backend/app/controllers/*.ts`
2. Add route in `apps/backend/start/routes.ts`
3. Use `middleware.auth()`
4. Test with authentication headers

## Testing

### Nuxt Server API
```bash
# Public endpoint
curl http://localhost:3000/api/posts
```

### AdonisJS Gateway
```bash
# Login first
curl -X POST http://localhost:3333/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}' \
  -c cookies.txt

# Use authenticated endpoint
curl http://localhost:3333/api/billing/subscriptions \
  -b cookies.txt
```

## Summary

| Feature              | Nuxt Server API | AdonisJS Gateway          |
| -------------------- | --------------- | ------------------------- |
| **Purpose**          | Public content  | Authenticated operations  |
| **Authentication**   | None            | Required                  |
| **Directus Access**  | Direct          | Proxied                   |
| **Lago Access**      | Never           | Always                    |
| **Performance**      | Faster          | Slightly slower           |
| **Security**         | Basic           | Advanced                  |
| **Use Case**         | Blog, docs, SEO | User data, billing, admin |

---

**Rule of Thumb**: If it's on your marketing site, use Nuxt Server API. If it requires login, use AdonisJS Gateway.


